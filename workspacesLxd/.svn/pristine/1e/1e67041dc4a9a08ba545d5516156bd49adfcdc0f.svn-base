<template>
  <div class="app-container">
    <el-form :model="queryParams"
       ref="queryForm"
       v-show="showSearch"
       label-width="90px">

         <el-row :gutter="15">
           <el-col :span="6">
              <el-form-item label="流程名称" prop="processInstanceName">
                <el-input
                  v-model="queryParams.processInstanceName"
                  placeholder="请输入流程名称"
                  clearable
                  size="small"
                  @keyup.enter.native="handleQuery"
                />
              </el-form-item>
           </el-col>
          <!-- <el-col :span="6">
              <el-form-item label="流程名称" prop="processInstanceName">
                <el-input
                  v-model="queryParams.processInstanceName"
                  placeholder="请输入流程名称"
                  clearable
                  size="small"
                  @keyup.enter.native="handleQuery"
                />
              </el-form-item>
           </el-col> -->


           <el-col :span="6">
             <el-form-item>
               <el-button type="cyan" icon="el-icon-search" size="mini" @click="handleQuery">搜索</el-button>
               <el-button icon="el-icon-refresh" size="mini" @click="resetQuery">重置</el-button>
             </el-form-item>
           </el-col>
         </el-row>
       </el-form>
    <el-table v-loading="loading" :data="tastList">
      <el-table-column label="流程id" align="center" prop="id" v-if="show"/>
      <el-table-column label="流程KEY" align="center" prop="definitionKey" v-if="show"/>
      <el-table-column label="流程名称" align="center" prop="instanceName"/>
      <el-table-column label="任务节点名称" align="center" prop="name"/>
      <el-table-column label="任务状态" align="center" prop="status"/>
      <el-table-column label="办理人" align="center" prop="assignee"/>
      <el-table-column label="创建时间" align="center" prop="createdDate"/>
<!-- v-hasPermi="['workflow:leave:edit']" -->
      <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
        <template slot-scope="scope">
          <span v-if="(scope.row.definitionKey == 'fjkxmDown' || scope.row.definitionKey == 'fjkxmUp' ) && scope.row.name == '本部部门主任审核'
           && scope.row.flag==true">
              <el-button
                size="mini"
                type="text"
                icon="el-icon-edit"
                @click="getTask(scope.row)"
              >转派
              </el-button>
          </span>
          <el-button
            size="mini"
            type="text"
            icon="el-icon-edit"
           @click="examineAndApprove (scope.row)"
          >审批
          </el-button>
          <el-button
            size="mini"
            type="text"
            icon="el-icon-view"
            @click="examineAndApproves (scope.row)"

          >查看流程图
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <pagination
      v-show="total>0"
      :total="total"
      :page.sync="queryParams.pageNum"
      :limit.sync="queryParams.pageSize"
      @pagination="getList"
    />

    <!-- 审批对话框 -->
    <el-dialog :title="title" :visible.sync="open" v-if="open" width="80%" append-to-body>
      <leaveHistoryForm :businessKey="businessKey"  v-if="audit"/>
      <collectOrder :businessKey="businessKey"  v-if="collectAudit"/>
      <contractInfo :businessKey="businessKey" v-if="contractAudit"/>
      <ngcInfo :businessKey="businessKey"  v-if="ngcAudit"/>

      <el-form :model="form" ref="form" label-width="100px" class="demo-dynamic">
        <el-form-item
          v-for="(domain, index) in form.formData"
          :label="domain.controlLable"
          :key="index"
        >
          <el-radio-group v-model="domain.controlValue" v-if="'radio'==domain.controlType">
            <el-radio v-for="(defaults,indexd) in domain.controlDefault.split('--__--')"
                      :label=indexd
                      :key="indexd"
                      >{{defaults}}

            </el-radio>

          </el-radio-group>
          <el-input type="textarea" v-model="domain.controlValue" v-if="'textarea'==domain.controlType"
          ></el-input>
        </el-form-item>
      </el-form>

      <div slot="footer" class="dialog-footer">
        <el-button type="primary" @click="submitForm">确 定</el-button>
        <el-button @click="cancel">取 消</el-button>
      </div>
    </el-dialog>

    <!--部门人员选中-->
          <el-dialog
                width="50%"
                height="70%"
                title="人员信息"
                :visible.sync="innerhtVisible"
                append-to-body>


                <el-form
                  :model="queryParams_"
                  ref="queryhtForm"
                  v-show="showSearch"
                  label-width="90px"
                >
                  <el-row >

                    <el-col :span="8">
                      <el-form-item label="账号" prop="userName" width="60%">
                        <el-input
                          v-model="queryParams.userName"
                          placeholder="请输入账号"
                          clearable
                          size="small"
                          @keyup.enter.native="handlesQuery_"
                        />
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="姓名" prop="nickName"  width="60%">
                        <el-input
                          v-model="queryParams.nickName"
                          placeholder="请输入项目名称"
                          clearable
                          size="small"
                          @keyup.enter.native="handlesQuery_"
                        />
                      </el-form-item>
                    </el-col>

                    <el-col :span="3">
                      <el-form-item>
                        <el-button
                          type="cyan"
                          icon="el-icon-search"
                          size="mini"
                          @click="handlesQuery_"
                          >搜索</el-button
                        >

                      </el-form-item>
                    </el-col>

                    <el-col :span="2">
                      <el-form-item>
                        <el-button icon="el-icon-refresh" size="mini" @click="resetQuery"
                          >重置</el-button
                        >
                      </el-form-item>
                    </el-col>

                  </el-row>

                </el-form>
                <el-table  ref="htTable"  v-loading="htloading" :data="userList">
                   <el-table-column type="selection" width="55" align="center" v-if="show"/>
                  <el-table-column label="唯一ID" align="center" prop="id" v-if="show" />
                  <el-table-column label="账号" align="center" prop="userName" />
                  <el-table-column label="姓名" align="center" prop="nickName" />
                  <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
                          <template slot-scope="scope">
                            <el-button
                              size="mini"
                              type="text"
                              icon="el-icon-edit"
                              @click="submithtForm(scope.row)"

                            >选择</el-button>

                          </template>
                        </el-table-column>
                </el-table>
                <pagination
                      v-show="total>0"
                      :total="total"
                      :page.sync="queryParams_.pageNum"
                      :limit.sync="queryParams_.pageSize"
                      @pagination="userList"
                    />

            <div slot="footer" class="dialog-footer">
              <!-- <el-button type="primary" @click="submithtForm">确 定</el-button> -->
              <el-button @click="innerhtVisible=false">取 消</el-button>
            </div>

        </el-dialog>

  </div>
</template>

<script>
  import {confirmTransfer,getUserByRole,listTask, formDataShow, formDataSave} from "@/api/activiti/task"; //导入接口js文件
  import leaveHistoryForm from './leaveHistoryForm.vue';  //导入自定义组件页面
  import collectOrder  from './collectOrder.vue';  //导入自定义组件页面
  import contractInfo  from './contractInfo.vue';  //导入自定义组件页面
  import ngcInfo from './ngcInfo.vue';  //导入自定义组件页面
  export default {
    name: "Leave",
    components: {leaveHistoryForm,collectOrder,contractInfo,ngcInfo},
    data() {
      return {
        //非极客
        ngcAudit:false,
        show:false,
        // 人员信息列表
        userList: [],
        htloading:true,
        //部门人员选中
        innerhtVisible:false,
        audit:false,
        //收款单
        collectAudit:false,
        //合同审核
        contractAudit:false,
        id:'',
        definitionKey: '',
        businessKey: '',
        // 遮罩层
        loading: true,
        // 选中数组
        ids: [],
        // 非单个禁用
        single: true,
        // 非多个禁用
        multiple: true,
        // 显示搜索条件
        showSearch: true,
        // 总条数
        total: 0,
        // 请假表格数据
        tastList: [],
        // 弹出层标题
        title: "",
        // 是否显示弹出层
        open: false,
        // 查询参数
        queryParams: {
          pageNum: 1,
          pageSize: 10,
        },
        // 查询参数
        queryParams_: {
          pageNum: 1,
          pageSize: 10,
        },
        // 表单参数
        form: {
          formData:[]
        },
        // 表单校验
        rules: {}
      };
    },
    created() {
      this.getList();
      this.getUserList();
    },
    methods: {
      getTask(row){
        this.id = row.id;
        this.innerhtVisible = true;
      },
      /** 搜索按钮操作 */
      handlesQuery_() {
        this.queryParams_.pageNum = 1;
        this.getUserList();
      },
     //获取人员信息
     getUserList() {
       this.htloading = true;
       getUserByRole(this.addDateRange(this.queryParams, this.dateRange)).then(response => {
         console.log(response.rows);
         this.userList = response.rows;
         this.total = response.total;
         this.htloading = false;
       });
     },
     /** 选择人员 */
     submithtForm(row) {
       const id = this.id;
       const userName = row.userName;
       this.$confirm('是否确认转派'+userName+'进行审核?', "警告", {
           confirmButtonText: "确定",
           cancelButtonText: "取消",
           type: "warning"
         }).then(function() {
           return confirmTransfer(id,userName);
         }).then(() => {
           this.getList();
           this.msgSuccess("转派成功");
           this.innerhtVisible = false;
         })
     },
      /** 查询请假列表 */
      getList() {
        this.loading = true;
        listTask(this.queryParams).then(response => {
          this.tastList = response.rows;
          this.total = response.total;
          this.loading = false;
        });
      },
      handleQuery() {
        this.queryParams.pageNum = 1;
        this.getList();
      },
      /** 重置按钮操作 */
      resetQuery() {
        this.resetForm("queryForm");
        this.handleQuery();
      },
 /** 查看流程图 */
      examineAndApproves(row) {
        this.reset();
        let url = window.location.hostname;
        if(url.indexOf("http")<0){
          url = "http://"+url;
        }
        let hosturl = url+":9001/task/exportImage?processInstanceId="+row.instanceId;
        window.open(hosturl,"_blank");
       },
      // 取消按钮
      cancel() {
        this.open = false;
        this.reset();
      },
      // 表单重置
      reset() {
        this.definitionKey = '',
          this.businessKey = '',
          this.form = {
            formData:[],
          };
        this.resetForm("form");
      },

      /** 审批按钮操作 */
      examineAndApprove(row) {
        this.reset();
        this.definitionKey = row.definitionKey;
        this.businessKey = row.businessKey;
        this.id=row.id;
        formDataShow(row.id).then(response => {
          let datas = response.data;
          let formData = []
          for (let i = 0; i < datas.length; i++) {
            let strings = datas[i].split('--__!!')
            let controlValue = null
            let controlDefault = null
            switch (strings[1]) {
              case 'radio':
                controlValue = 0;
                controlDefault = strings[4]
                break;
              // default:
            }
            formData.push({
              controlId: strings[0],
              controlType: strings[1],
              controlLable: strings[2],
              controlIsParam: strings[3],
              controlValue: controlValue,
              controlDefault: controlDefault
            })
          }
          this.getDioag(row.instanceName);
          this.form.formData = formData;
          this.open = true;
          this.title = "审批";
          //添加表单

        });
      },
      getDioag(obj){
        if(obj.indexOf("发票申请")>=0 || obj.indexOf("开票申请")>=0){
          this.audit = true;
          this.collectAudit = false;
          this.contractAudit = false;
           this.ngcAudit = false;
        }
        if(obj.indexOf("收款单审核")>=0){
          this.collectAudit = true;
           this.audit = false;
           this.contractAudit = false;
            this.ngcAudit = false;
        }
        if(obj.indexOf("合同审核")>=0){
          this.contractAudit = true;
           this.addOrUpdateVisible = false;
           this.collectAudit = false;
           this.ngcAudit = false;
        }
        if(obj.indexOf("非集客10w限额以下的审批")>=0 || obj.indexOf("非集客项目(限额以上的审批流程)")>=0){
          this.contractAudit = false;
           this.addOrUpdateVisible = false;
           this.collectAudit = false;
           this.ngcAudit = true;
        }
      },
      /** 提交按钮 */
      submitForm() {
        formDataSave(this.id,this.form.formData).then(response => {
          this.msgSuccess("审批成功");
          this.open = false;
          this.getList();
        });
      },
    }
  };
</script>
