

package com.ruoyi.activiti.service.impl;

import com.github.pagehelper.Page;
import com.ruoyi.activiti.domain.ActWorkflowFormData;
import com.ruoyi.activiti.domain.Invoice;
import com.ruoyi.activiti.domain.dto.ActWorkflowFormDataDTO;
import com.ruoyi.activiti.domain.dto.ActTaskDTO;
import com.ruoyi.activiti.mapper.ActWorkflowFormDataMapper;
import com.ruoyi.activiti.service.IActTaskService;
import com.ruoyi.activiti.service.IActWorkflowFormDataService;
import com.ruoyi.collection.domain.CtBuInvoiceReq;
import com.ruoyi.collection.domain.CtBuInvoiceReqDto;
import com.ruoyi.collection.service.ICtBuInvoiceReqService;
import com.ruoyi.common.core.domain.model.LoginUser;
import com.ruoyi.common.core.page.PageDomain;
import com.ruoyi.common.utils.SecurityUtils;
import org.activiti.api.runtime.shared.query.Pageable;
import org.activiti.api.task.model.Task;
import org.activiti.api.task.model.builders.TaskPayloadBuilder;
import org.activiti.api.task.runtime.TaskRuntime;
import org.activiti.bpmn.model.*;
import org.activiti.engine.HistoryService;
import org.activiti.engine.RepositoryService;
import org.activiti.engine.RuntimeService;
import org.activiti.engine.TaskService;
import org.activiti.engine.history.*;
import org.activiti.engine.impl.persistence.entity.ProcessDefinitionEntity;
import org.activiti.engine.repository.ProcessDefinition;
import org.activiti.engine.runtime.ProcessInstance;
import org.activiti.engine.runtime.ProcessInstanceQuery;
import org.activiti.engine.task.TaskQuery;

import org.activiti.image.ProcessDiagramGenerator;
import org.activiti.image.impl.DefaultProcessDiagramGenerator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.servlet.http.HttpServletResponse;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.text.ParseException;
import java.util.*;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ActTaskServiceImpl implements IActTaskService {

    @Autowired
    private RepositoryService repositoryService;

    @Autowired
    private TaskRuntime taskRuntime;
    @Autowired
    private RuntimeService runtimeService;
    @Autowired
    private IActWorkflowFormDataService actWorkflowFormDataService;
    @Autowired
    private TaskService taskService;

    @Autowired
    private HistoryService historyService;
    @Autowired
    private ActWorkflowFormDataMapper actWorkflowFormDataMapper;
    @Autowired
    private ProcessDiagramGenerator processDiagramGenerator;
    @Autowired
    private ICtBuInvoiceReqService iCtBuInvoiceReqService;

    @Override
    public void exportImage(HttpServletResponse response, String processInstanceId) {
        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery()
                .processInstanceId(processInstanceId).singleResult();
        String processDefinitionId = "";
        boolean flag = false;
        //如果执行中的查询不到，查询历史记录
        if(processInstance==null){
            List<HistoricActivityInstance>  list=historyService // 历史相关Service
                    .createHistoricActivityInstanceQuery() // 创建历史活动实例查询
                    .processInstanceId(processInstanceId) // 执行流程实例id
                    .finished()
                    .list();
            HistoricActivityInstance hai = list.get(0);
            processDefinitionId = hai.getProcessDefinitionId();
            flag = true;

        }else{
            processDefinitionId = processInstance.getProcessDefinitionId();
        }
        BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinitionId);
        HistoricActivityInstanceQuery historyInstanceQuery = historyService.createHistoricActivityInstanceQuery()
                .processInstanceId(processInstanceId);

        response.setContentType("text/html;charset=utf-8");
        // 查询历史节点
        List<HistoricActivityInstance> historicActivityInstanceList = historyInstanceQuery
                .orderByHistoricActivityInstanceStartTime().asc().list();
        List<String> executedActivityIdList = historicActivityInstanceList.stream().map(item -> item.getActivityId())
                .collect(Collectors.toList());

        InputStream imageStream = null;
        if(flag){
            imageStream = processDiagramGenerator.generateDiagram(bpmnModel, "宋体", "宋体", "宋体");
        }else{
             imageStream = processDiagramGenerator.generateDiagram(bpmnModel,runtimeService.getActiveActivityIds(processInstanceId),Collections.<String>emptyList(), "宋体", "宋体", "宋体");
        }

        //        try {
//            Font font = Font.createFont(Font.TRUETYPE_FONT, imageStream);
//            GraphicsEnvironment.getLocalGraphicsEnvironment().registerFont(font);
//        } catch (FontFormatException e) {
//            e.printStackTrace();
//        } catch (IOException e) {
//            e.printStackTrace();
//        }

//        InputStream imageStream = processDiagramGenerator.generateDiagram(bpmnModel,
//                highLightedActivitiIds, highLightedFlowIds, "宋体",
//                "微软雅黑", "黑体");

        byte[] b = new byte[1024];
        int len;
        try {
            while ((len = imageStream.read(b, 0, 1024)) != -1) {
                response.getOutputStream().write(b, 0, len);
            }
            response.setCharacterEncoding("utf-8");
            response.getOutputStream().flush();
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        } finally { // 流关闭
            try {
                imageStream.close();
            } catch (IOException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }
    }
    @Override
    public InputStream findProcessPic(String procDefId) {
       // ProcessDefinition definition = getProcessDefinition(procDefId);
        ProcessDefinition definition = repositoryService.createProcessDefinitionQuery()
                .processDefinitionKey("invoiceApply").processDefinitionVersion(7)
                .singleResult();
        String source = definition.getDiagramResourceName();
        InputStream inputStream = repositoryService.getResourceAsStream(definition.getDeploymentId(),source);
        return inputStream;
    }


    /**
     * 查询业务表id。
     *
     * @param assignee 用户
     * @return 已处理任务列表
     */

    @Override
    public Map selectBuessKeyByExe(String id){
        return actWorkflowFormDataMapper.selectBuessKeyByExe(id);
    }
    /**
     * 查询已处理任务列表。
     *
     * @param assignee 用户
     * @return 已处理任务列表
     */

    @Override
    public Page<ActTaskDTO> queryDoneTasks(PageDomain pageDomain) {
        LoginUser loginUser = SecurityUtils.getLoginUser();

        List<ActTaskDTO> lists= new ArrayList<>();
        List<HistoricTaskInstance> historicTaskInstances = historyService.createHistoricTaskInstanceQuery()
                .taskAssignee((loginUser.getUser().getUserName()))
                .finished().listPage((pageDomain.getPageNum() - 1) * pageDomain.getPageSize(), pageDomain.getPageSize());
        if(historicTaskInstances!=null && historicTaskInstances.size()>0){

            for(HistoricTaskInstance historicTaskInstance:historicTaskInstances) {
                ActTaskDTO dto = new ActTaskDTO();
                HistoricProcessInstance processInstance = historyService.createHistoricProcessInstanceQuery().
                        processInstanceId(historicTaskInstance.getProcessInstanceId()).singleResult();

                dto.setInstanceName(processInstance.getProcessDefinitionName());
                dto.setId(processInstance.getId());
                dto.setName(historicTaskInstance.getName());
//                dto.setStatus(historicTaskInstance.get);
                dto.setBusinessKey(processInstance.getBusinessKey());
                dto.setCreatedDate(historicTaskInstance.getEndTime());

                lists.add(dto);
            }
        }
        //Page<HistoricTaskInstance> list = new Page<HistoricTaskInstance>();
        Page<ActTaskDTO> list = new Page<ActTaskDTO>();
        int totalItems_ = historicTaskInstances.size()
;
        list.setTotal(totalItems_);

        list.addAll(lists);


        return list;
    }



    @Override
    public Page<ActTaskDTO> selectProcessDefinitionList(PageDomain pageDomain) {
        Page<ActTaskDTO> list = new Page<ActTaskDTO>();
        org.activiti.api.runtime.shared.query.Page<Task> pageTasks = taskRuntime.tasks(Pageable.of((pageDomain.getPageNum() - 1) * pageDomain.getPageSize(), pageDomain.getPageSize()));
        List<Task> tasks = pageTasks.getContent();
        int totalItems = pageTasks.getTotalItems();
        list.setTotal(totalItems);
        if (totalItems != 0) {
            Set<String> processInstanceIdIds = tasks.parallelStream().map(t -> t.getProcessInstanceId()).collect(Collectors.toSet());
            List<ProcessInstance> processInstanceList = runtimeService.createProcessInstanceQuery().processInstanceIds(processInstanceIdIds).list();
            List<ActTaskDTO> actTaskDTOS = tasks.stream()
                    .map(t -> new ActTaskDTO(t, processInstanceList.parallelStream().filter(pi -> t.getProcessInstanceId().equals(pi.getId())).findAny().get()))
                    .collect(Collectors.toList());
            list.addAll(actTaskDTOS);

        }
        return list;
    }

    @Override
    public List<String> formDataShow(String taskID) {
        Task task = taskRuntime.task(taskID);
/*  ------------------------------------------------------------------------------
            FormProperty_0ueitp2--__!!类型--__!!名称--__!!是否参数--__!!默认值
            例子：
            FormProperty_0lovri0--__!!string--__!!姓名--__!!f--__!!同意!!__--驳回
            FormProperty_1iu6onu--__!!int--__!!年龄--__!!s

            默认值：无、字符常量、FormProperty_开头定义过的控件ID
            是否参数：f为不是参数，s是字符，t是时间(不需要int，因为这里int等价于string)
            注：类的，但是为了统一配置原则，型是可以获取到都配置到
            */





        //注意!!!!!!!!:表单Key必须要任务编号一模一样，因为参数需要任务key，但是无法获取，只能获取表单key“task.getFormKey()”当做任务key
        UserTask userTask = (UserTask) repositoryService.getBpmnModel(task.getProcessDefinitionId())
                .getFlowElement(task.getFormKey());

        if (userTask == null) {
            return null;
        }
        List<FormProperty> formProperties = userTask.getFormProperties();
        List<String> collect = formProperties.stream().map(fp -> fp.getId()).collect(Collectors.toList());

        return collect;
    }

    @Override
    public int formDataSave(String taskID, List<ActWorkflowFormDataDTO> awfs) throws ParseException {
        Task task = taskRuntime.task(taskID);
        ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(task.getProcessInstanceId()).singleResult();

        Boolean hasVariables = false;//没有任何参数
        HashMap<String, Object> variables = new HashMap<String, Object>();
        //前端传来的字符串，拆分成每个控件
        List<ActWorkflowFormData> acwfds = new ArrayList<>();
        for (ActWorkflowFormDataDTO awf : awfs) {
            ActWorkflowFormData actWorkflowFormData = new ActWorkflowFormData(processInstance.getBusinessKey(), awf, task);
            acwfds.add(actWorkflowFormData);
            //构建参数集合
            if (!"f".equals(awf.getControlIsParam())) {
                variables.put(awf.getControlId(), awf.getControlValue());
                hasVariables = true;
            }
        }//for结束
        if (task.getAssignee() == null) {
            taskRuntime.claim(TaskPayloadBuilder.claim().withTaskId(task.getId()).build());
        }
        if (hasVariables) {
            //带参数完成任务
            taskRuntime.complete(TaskPayloadBuilder.complete().withTaskId(taskID)
                    .withVariables(variables)
                    .build());
        } else {
            taskRuntime.complete(TaskPayloadBuilder.complete().withTaskId(taskID)
                    .build());
        }

        //审核不通过修改主表状态
        if(acwfds!=null && acwfds.size()>0){
            for (ActWorkflowFormData data:acwfds) {
                if("不同意".equals(data.getControlValue())){
                    //修改业务表 状态
                    CtBuInvoiceReqDto req = new CtBuInvoiceReqDto();
                    req.setStatus(3);
                    req.setInstanceId(processInstance.getId());
                    iCtBuInvoiceReqService.updatesCtBuInvoiceReq(req);
                }
            }
        }
        //写入数据库
        return actWorkflowFormDataService.insertActWorkflowFormDatas(acwfds);
    }



}
