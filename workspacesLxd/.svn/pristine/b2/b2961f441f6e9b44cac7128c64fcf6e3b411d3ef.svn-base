package com.ruoyi.collection.service.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.ruoyi.common.core.domain.entity.SysUser;
import com.ruoyi.common.core.domain.model.LoginUser;
import com.ruoyi.common.utils.DateUtils;
import com.ruoyi.common.utils.SecurityUtils;
import com.ruoyi.common.utils.uuid.UUID;
import com.ruoyi.collection.domain.CtBuInvoiceReqDetail;
import com.ruoyi.collection.domain.CtBuInvoiceReqDto;
import com.ruoyi.collection.mapper.CtBuInvoiceReqDetailMapper;
import com.ruoyi.system.service.ISysUserService;
import com.sun.jmx.snmp.tasks.TaskServer;
import org.activiti.api.process.model.ProcessInstance;
import org.activiti.api.process.model.builders.ProcessPayloadBuilder;
import org.activiti.api.process.runtime.ProcessRuntime;
import org.activiti.api.task.model.builders.TaskPayloadBuilder;
import org.activiti.api.task.runtime.TaskRuntime;
import org.activiti.engine.ProcessEngine;
import org.activiti.engine.ProcessEngines;
import org.activiti.engine.RepositoryService;
import org.activiti.engine.TaskService;
import org.activiti.engine.task.Task;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.ruoyi.collection.mapper.CtBuInvoiceReqMapper;
import com.ruoyi.collection.domain.CtBuInvoiceReq;
import com.ruoyi.collection.service.ICtBuInvoiceReqService;
import org.springframework.transaction.annotation.Transactional;

/**
 * 发票申请Service业务层处理
 * 
 * @author ruoyi
 * @date 2020-12-09
 */

@Service
public class CtBuInvoiceReqServiceImpl implements ICtBuInvoiceReqService 
{
    @Autowired
    private CtBuInvoiceReqMapper ctBuInvoiceReqMapper;

    @Autowired
    private CtBuInvoiceReqDetailMapper ctBuInvoiceReqDetailMapper;

    @Autowired
    private ProcessRuntime processRuntime;

    @Autowired
    private TaskRuntime taskRuntime;
    @Autowired
    private RepositoryService repositoryService;
    @Autowired
    private TaskService taskService;

    @Autowired
    private ISysUserService iSysUserService;




    /**
     * 查询发票申请
     * 
     * @param id 发票申请ID
     * @return 发票申请
     */
    @Override
    public CtBuInvoiceReqDto selectCtBuInvoiceReqById(String id)
    {
        CtBuInvoiceReqDto dto = ctBuInvoiceReqMapper.selectCtBuInvoiceReqDtoById(id);
//        CtBuInvoiceReq req = ctBuInvoiceReqMapper.selectCtBuInvoiceReqById(id);
//        if(req!=null && req.getId()!=null){
//            CtBuInvoiceReqDetail detail = new CtBuInvoiceReqDetail();
//            detail.setInvoiceId(req.getId());
//           List<CtBuInvoiceReqDetail> list =  ctBuInvoiceReqDetailMapper.selectCtBuInvoiceReqDetailList(detail);
//           if(list!=null && list.size()>0){
//               req.setCtBuInvoiceReqDetail(list.get(0));
//           }
//        }
        return dto;
    }

    /**
     * 查询发票申请列表
     * 
     * @param ctBuInvoiceReq 发票申请
     * @return 发票申请
     */
    @Override
    public List<CtBuInvoiceReq> selectCtBuInvoiceReqList(CtBuInvoiceReq ctBuInvoiceReq)
    {
        return ctBuInvoiceReqMapper.selectCtBuInvoiceReqList(ctBuInvoiceReq);
    }

    /**
     * 新增发票申请
     * 
     * @param ctBuInvoiceReq 发票申请
     * @return 结果
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public int insertCtBuInvoiceReq(CtBuInvoiceReqDto ctBuInvoiceReq)
    {
        String uuid = UUID.fastUUID().toString(true);
        ctBuInvoiceReq.setCreateTime(DateUtils.getNowDate());
        ctBuInvoiceReq.setId(uuid);
        ctBuInvoiceReq.setDelFlag("1");
        /** 判断当前登录人 **/
        LoginUser loginUser = SecurityUtils.getLoginUser();
        if (loginUser != null && loginUser.getUser() != null) {
            ctBuInvoiceReq.setCreateBy(loginUser.getUser().getUserId().toString());
        }
        //实列
        if("1".equals(ctBuInvoiceReq.getState())){
            Map<String, Object> variables = new HashMap<String, Object>();
            variables.put("apply",loginUser.getUsername());
            //获取当前登陆人的所属部门
           long dept_id = loginUser.getUser().getDept().getDeptId();
           //查询部门为当前登陆人，角色为分公司负责人
            List<String> ulist = new ArrayList();
            Map params = new HashMap();
            params.put("roleId","103");
            params.put("deptId",dept_id);
            List<SysUser> users = iSysUserService.selectUserByRoleDept(params);
            if(users!=null && users.size()>0){
                for (SysUser user:users)  {
                    ulist.add(user.getUserName());
                }
            }
            variables.put("companyFinaAudit",ulist);
            ProcessInstance processInstance = processRuntime.start(ProcessPayloadBuilder
                    .start()
                    .withProcessDefinitionKey("invoiceApply")
                    .withName("开票申请")
                    .withBusinessKey(uuid)
                    .withVariables(variables)
                    .build());
            ctBuInvoiceReq.setInstanceId(processInstance.getId());
            ctBuInvoiceReq.setState("1");

            // 根据流程实例Id查询任务
            Task task =  taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();
//            Task task1 = taskService.createTaskQuery()
//                    .processDefinitionKey("invoiceApply")
//                    .taskAssignee(loginUser.getUsername())
//                    .singleResult();
            //完成任务
            taskRuntime.complete(TaskPayloadBuilder.complete().withTaskId(task.getId())
                    .build());

        }
        int num = ctBuInvoiceReqMapper.insertCtBuInvoiceReq(ctBuInvoiceReq);
        if(num>0){
            //添加字表
            CtBuInvoiceReqDetail detail = new CtBuInvoiceReqDetail();
            detail.setId(UUID.fastUUID().toString(true));
            detail.setInvoiceId(uuid);
            detail.setInvoiceProName(ctBuInvoiceReq.getInvoiceProName());
            detail.setInvoiceSpec(ctBuInvoiceReq.getInvoiceSpec());
            detail.setInvoiceType(ctBuInvoiceReq.getInvoiceTypes());
            detail.setUnit(ctBuInvoiceReq.getUnit());
            detail.setInvoicePrice(ctBuInvoiceReq.getInvoicePrice());
            if (loginUser != null && loginUser.getUser() != null) {
                detail.setCreateBy(loginUser.getUser().getUserId().toString());
            }
            detail.setDelFlag("1");
            detail.setCreateTime(DateUtils.getNowDate());
            ctBuInvoiceReqDetailMapper.insertCtBuInvoiceReqDetail(detail);
        }
        return num;
    }

    /**
     * 修改发票申请
     * 
     * @param ctBuInvoiceReq 发票申请
     * @return 结果
     */
    @Override
    public int updateCtBuInvoiceReq(CtBuInvoiceReqDto ctBuInvoiceReq)
    {
        ctBuInvoiceReq.setUpdateTime(DateUtils.getNowDate());
        LoginUser loginUser = SecurityUtils.getLoginUser();
        if (loginUser != null && loginUser.getUser() != null) {
            ctBuInvoiceReq.setUpdateBy(loginUser.getUser().getUserId().toString());
        }
        //实列
        if("1".equals(ctBuInvoiceReq.getState())){
            ProcessInstance processInstance = processRuntime.start(ProcessPayloadBuilder
                    .start()
                    .withProcessDefinitionKey("invoiceApply")
                    .withName("开票申请")
                    .withBusinessKey(ctBuInvoiceReq.getId())
                    .withVariable("billApply",loginUser.getUser().getUserName())
                    .build());
            ctBuInvoiceReq.setInstanceId(processInstance.getId());
            ctBuInvoiceReq.setState("1");
        }


        int num = ctBuInvoiceReqMapper.updateCtBuInvoiceReq(ctBuInvoiceReq);
        if(num>0){
            //添加字表
            CtBuInvoiceReqDetail detail = new CtBuInvoiceReqDetail();
           // detail.setInvoiceId(uuid);
            detail.setInvoiceProName(ctBuInvoiceReq.getInvoiceProName());
            detail.setInvoiceSpec(ctBuInvoiceReq.getInvoiceSpec());
            detail.setInvoiceType(ctBuInvoiceReq.getInvoiceTypes());
            detail.setUnit(ctBuInvoiceReq.getUnit());
            detail.setInvoicePrice(ctBuInvoiceReq.getInvoicePrice());
            if (loginUser != null && loginUser.getUser() != null) {
                detail.setUpdateBy(loginUser.getUser().getUserId().toString());
            }
            detail.setInvoiceId(ctBuInvoiceReq.getId());
            detail.setDelFlag("1");
            detail.setUpdateTime(DateUtils.getNowDate());
            ctBuInvoiceReqDetailMapper.updateCtBuInvoiceReqDetail(detail);
        }
        return num;
    }

    /**
     * 批量删除发票申请
     * 
     * @param ids 需要删除的发票申请ID
     * @return 结果
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public int deleteCtBuInvoiceReqByIds(String[] ids)
    {
        int num = ctBuInvoiceReqMapper.deleteCtBuInvoiceReqByIds(ids);
        if(num>0){
            ctBuInvoiceReqDetailMapper.deleteCtBuInvoiceReqDetailByIds(ids);
        }
        return num;
    }

    /**
     * 删除发票申请信息
     * 
     * @param id 发票申请ID
     * @return 结果
     */
    @Override
    public int deleteCtBuInvoiceReqById(String id)
    {
        return ctBuInvoiceReqMapper.deleteCtBuInvoiceReqById(id);
    }
}
