package com.ruoyi.projectApproval.AppNgc.service.impl;

import java.util.List;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.ruoyi.base.cache.service.CacheService;
import com.ruoyi.base.fileManage.domain.CtBuFile;
import com.ruoyi.base.fileManage.service.ICtBuFileService;
import com.ruoyi.common.core.domain.entity.SysDept;
import com.ruoyi.common.utils.DateUtils;
import com.ruoyi.common.utils.DictUtils;
import com.ruoyi.common.utils.SecurityUtils;
import com.ruoyi.common.utils.uuid.UUID;
import com.ruoyi.dictionary.proType.domain.CtDicProtype;
import com.ruoyi.projectApproval.AppNgc.domain.AppNgc;
import com.ruoyi.projectApproval.AppNgc.mapper.AppNgcMapper;
import com.ruoyi.projectApproval.AppNgc.service.IAppNgcService;
import com.ruoyi.system.service.ISysDeptService;

/**
 * 非集客项目Service业务层处理
 * 
 * @author ruoyi
 * @date 2020-12-11
 */
@Service
public class AppNgcServiceImpl implements IAppNgcService {

	@Autowired
	private AppNgcMapper appNgcMapper;

	@Autowired
	private ISysDeptService deptService;

	@Autowired
	private CacheService cacheService;

	@Autowired
	private ICtBuFileService fileService;

	/**
	 * 查询非集客项目
	 * 
	 * @param id 非集客项目ID
	 * @return 非集客项目
	 */
	@Override
	public AppNgc selectAppNgcById(String id) {
		return appNgcMapper.selectAppNgcById(id);
	}

	/**
	 * 查询非集客项目列表
	 * 
	 * @param appNgc 非集客项目
	 * @return 非集客项目
	 */
	@Override
	public List<AppNgc> selectAppNgcList(AppNgc appNgc) {
		List<AppNgc> list = appNgcMapper.selectAppNgcList(appNgc);
		if (list != null && !list.isEmpty()) {
			for (int i = 0; i < list.size(); i++) {
				/** 项目类型名称 **/
				CtDicProtype protype = cacheService.findProtypeById(list.get(i).getProType());
				if (protype != null && StringUtils.isNotBlank(protype.getId())) {
					list.get(i).setProTypeName(protype.getTypeName());
				}
				/** 项目分类 **/
				if (list.get(i).getClassification() != null) {
					list.get(i)
							.setClassName(DictUtils.getDictLabel("project_sort", list.get(i).getClassification() + ""));
				}
				/** 所属分公司+部门 **/
				if (StringUtils.isNotBlank(list.get(i).getBelongCompanyid())) {
					SysDept company = cacheService.findSysDeptById(list.get(i).getBelongCompanyid());
					if (company != null && StringUtils.isNotBlank(company.getDeptName())) {
						list.get(i).setBelongCompanyname(company.getDeptName());
					}
				}
				if (StringUtils.isNotBlank(list.get(i).getBelongDeptid())) {
					SysDept dept = cacheService.findSysDeptById(list.get(i).getBelongDeptid());
					if (dept != null && StringUtils.isNotBlank(dept.getDeptName())) {
						list.get(i).setBelongDeptname(dept.getDeptName());
					}
				}
			}
		}
		return list;
	}

	/**
	 * 新增非集客项目
	 * 
	 * @param appNgc 非集客项目
	 * @return 结果
	 */
	@Override
	public int insertAppNgc(AppNgc appNgc) {
		appNgc.setId(UUID.fastUUID().toString(true));
		String userId = "";
		try {
			userId = SecurityUtils.getLoginUser().getUser().getUserId().toString();
		} catch (Exception e) {

		}
		appNgc.setCreateBy(userId);
		appNgc.setDelFlag(1);
		appNgc.setReqNo(createReqNo(SecurityUtils.getLoginUser().getUser().getDeptId(), appNgc.getClassification()));
		appNgc.setCreateTime(DateUtils.getNowDate());
		if (StringUtils.isNotBlank(appNgc.getProType())) {
			/** 根据项目ID获取项目信息 **/
			CtDicProtype protype = cacheService.findProtypeById(appNgc.getProType());
			if (protype != null && StringUtils.isNotBlank(protype.getId())) {
				appNgc.setProName(protype.getTypeName());
			}
		}

		/** 所属分公司 **/
		if (StringUtils.isNotBlank(appNgc.getBelongCompanyid())) {
			SysDept sysDept = cacheService.findSysDeptById(appNgc.getBelongCompanyid());
			if (sysDept != null && StringUtils.isNotBlank(sysDept.getDeptName())) {
				appNgc.setBelongCompanyname(sysDept.getDeptName());
			}
		}
		/** 所属部门 **/
		if (StringUtils.isNotBlank(appNgc.getBelongDeptid())) {
			SysDept dept = cacheService.findSysDeptById(appNgc.getBelongDeptid());
			if (dept != null && StringUtils.isNotBlank(dept.getDeptName())) {
				appNgc.setBelongDeptname(dept.getDeptName());
			}
		}
		/** 处理文件 **/
		if (StringUtils.isNotBlank(appNgc.getFiles())) {
			String[] str = appNgc.getFiles().split(",");
			for (int i = 0; i < str.length; i++) {
				/** 判断传入文件ID是否为空 **/
				if (StringUtils.isNotBlank(str[i])) {
					CtBuFile file = new CtBuFile();
					file.setId(str[i]);
					file.setPid(appNgc.getId());
					fileService.updateCtBuFile(file);
				}
			}
		}
		/** 清除files字段 **/
		appNgc.setFiles(null);
		appNgc.setStatus(0);
		appNgc.setStatusPs("保存");
		return appNgcMapper.insertAppNgc(appNgc);
	}

	/**
	 * 修改非集客项目
	 * 
	 * @param appNgc 非集客项目
	 * @return 结果
	 */
	@Override
	public int updateAppNgc(AppNgc appNgc) {
		appNgc.setUpdateTime(DateUtils.getNowDate());
		return appNgcMapper.updateAppNgc(appNgc);
	}

	/**
	 * 批量删除非集客项目
	 * 
	 * @param ids 需要删除的非集客项目ID
	 * @return 结果
	 */
	@Override
	public int deleteAppNgcByIds(String[] ids) {
		return appNgcMapper.deleteAppNgcByIds(ids);
	}

	/**
	 * 删除非集客项目信息
	 * 
	 * @param id 非集客项目ID
	 * @return 结果
	 */
	@Override
	public int deleteAppNgcById(String id) {
		return appNgcMapper.deleteAppNgcById(id);
	}

	/**
	 * @Title: AppNgcServiceImpl.java
	 * @Description: 生成非集客项目编号
	 * @Description: deptId ---所属部门ID
	 * @Description: falg ---收入/支出(1收入2支出)
	 * @Author M.Mu
	 * @Date 2020-12-11
	 */
	public String createReqNo(Long deptId, Integer falg) {
		/** 根据所属分公司ID获取分公司全名 **/
		if (deptId != null && falg != null) {
			/** 1、公司别名 **/
			String company = "JN";
			/** 根据当前登录人的所属公司ID获取公司名称 **/
			SysDept sysDept = deptService.selectDeptById(deptId);
			if (sysDept != null && StringUtils.isNotBlank(sysDept.getDeptName())) {
				if (sysDept.getDeptName().contains("宽带")) {
					company = "KD";
				} else if (sysDept.getDeptName().contains("数字")) {
					company = "SZ";
				} else if (sysDept.getDeptName().contains("本部")) {
					company = "JN";
				} else if (sysDept.getDeptName().contains("历下")) {
					company = "LX";
				} else if (sysDept.getDeptName().contains("市中")) {
					company = "SZ";
				} else if (sysDept.getDeptName().contains("槐荫")) {
					company = "HY";
				} else if (sysDept.getDeptName().contains("天桥")) {
					company = "TQ";
				} else if (sysDept.getDeptName().contains("济阳")) {
					company = "JY";
				} else if (sysDept.getDeptName().contains("商河")) {
					company = "SH";
				} else if (sysDept.getDeptName().contains("平阴")) {
					company = "PI";
				} else if (sysDept.getDeptName().contains("长清")) {
					company = "CQ";
				} else if (sysDept.getDeptName().contains("章丘")) {
					company = "ZQ";
				} else if (sysDept.getDeptName().contains("莱芜")) {
					company = "LW";
				} else if (sysDept.getDeptName().contains("先行")) {
					company = "XX";
				}
			}
			/** 2、类型 **/
			String falgStr = "1";
			if (falg == 1) {
				falgStr = "1";
			} else {
				falgStr = "2";
			}
			/** 3、年月 **/
			String date = DateUtils.dateTime();
			/** 4、当月集客项目数量(5位) **/
			String numStr = "";
			AppNgc appNgc = new AppNgc();
			appNgc.setStime(DateUtils.getMonthBegin(DateUtils.getDate()));
			appNgc.setEtime(DateUtils.getMonthEnd(DateUtils.getDate()));
			Integer nums = appNgcMapper.findNumsByData(appNgc);
			if (nums != null && nums > 0) {
				numStr = com.ruoyi.common.utils.StringUtils.getStringByInt(nums);
			} else {
				numStr = com.ruoyi.common.utils.StringUtils.getStringByInt(0);
			}
			return company + falgStr + date + numStr;
		}
		return "";
	}

}