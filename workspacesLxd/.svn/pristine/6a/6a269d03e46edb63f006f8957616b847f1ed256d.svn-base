<template>
  <div class="app-container">
    <el-form :model="queryParams" ref="queryForm" v-show="showSearch" label-width="90px">
      <el-row :gutter="15">

        <el-col :span="6">
          <el-form-item label="项目名称" prop="proName">
            <el-input
              v-model="queryParams.proName"
              placeholder="请输入项目名称"
              clearable
              size="small"
              @keyup.enter.native="handleQuery"
            />
          </el-form-item>
        </el-col>

        <el-col :span="6">
          <el-form-item label="合同名称" prop="contractName">
            <el-input
              v-model="queryParams.contractName"
              placeholder="请输入合同名称"
              clearable
              size="small"
              @keyup.enter.native="handleQuery"
            />
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item label="发票代码" prop="invoiceCode">
            <el-input
              v-model="queryParams.invoiceCode"
              placeholder="请输入发票代码"
              clearable
              size="small"
              @keyup.enter.native="handleQuery"
            />
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item label="发票号码" prop="invoiceNo">
            <el-input
              v-model="queryParams.invoiceNo"
              placeholder="请输入发票号码"
              clearable
              size="small"
              @keyup.enter.native="handleQuery"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="15">


        <el-col :span="6">
          <el-form-item label="单据编号" prop="documentNumber">
            <el-input
              v-model="queryParams.documentNumber"
              placeholder="请输入单据编号"
              clearable
              size="small"
              @keyup.enter.native="handleQuery"
            />
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item label="回款方式" prop="paymentMethod">
            <el-select :style="{ width: '100%' }"
                       v-model="queryParams.paymentMethod"
                       placeholder="合同类别"
            >
              <el-option
                v-for="dict in collectMethodList"
                :key="dict.dictValue"
                :label="dict.dictLabel"
                :value="dict.dictValue"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="6" >
          <el-form-item>
            <el-button type="cyan" icon="el-icon-search" size="mini" @click="handleQuery">搜索</el-button>
            <el-button icon="el-icon-refresh" size="mini" @click="resetQuerys">重置</el-button>
          </el-form-item>
        </el-col>
      </el-row>

    </el-form>

    <el-row :gutter="10" class="mb8">

      <el-col :span="1.5">
        <el-button
          type="success"
          icon="el-icon-edit"
          size="mini"
          :disabled="single"
          @click="handleUpdate"
          v-hasPermi="['collection:receiptInfo:edit']"
        >添加</el-button>
      </el-col>
      <el-col :span="1.5">
        <el-button
          type="danger"
          icon="el-icon-delete"
          size="mini"
          :disabled="multiple"
          @click="handleDelete"
          v-hasPermi="['collection:receiptInfo:remove']"
        >删除</el-button>
      </el-col>
      <!--
      <el-col :span="1.5">
        <el-button
          type="warning"
          icon="el-icon-download"
          size="mini"
          @click="handleExport"
          v-hasPermi="['collection:receiptInfo:export']"
        >导出</el-button>
      </el-col>
      -->
      <right-toolbar :showSearch.sync="showSearch" @queryTable="getList"></right-toolbar>
    </el-row>

    <el-table v-loading="loading" ref="financialList"  :data="financialList" @selection-change="handleSelectionChange">
      <el-table-column type="selection" width="55" style="text-align: center ;"  />
      <el-table-column label="主键" style="text-align: center ;"  prop="id" v-if="show"/>
      <el-table-column label="reqid" style="text-align: center ;"  prop="ctBuInvoiceReqVo.id_"   v-if="show"/>

      <el-table-column label="事情审批id" style="text-align: center ;"  prop="ctBuInvoiceReqVo.approvalId_"   v-if="show"/>
      <el-table-column label="项目编号" style="text-align: center ;"  prop="ctBuInvoiceReqVo.proNo_"   v-if="show"/>
      <el-table-column label="合同id" style="text-align: center ;"  prop="ctBuInvoiceReqVo.contractId_"  v-if="show"/>
      <el-table-column label="合同编号" style="text-align: center ;"  prop="ctBuInvoiceReqVo.contractNo_"  v-if="show"/>
      <el-table-column label="发票pid" style="text-align: center ;"  prop="ctBuInvoiceReqVo.id_"  v-if="show"/>


      <el-table-column label="主键" style="text-align: center ;"  v-if="show" prop="ctBuInvoiceReqVo.id_" />
      <el-table-column label="项目名称" style="text-align: center ;"  prop="ctBuInvoiceReqVo.proName_" />
      <el-table-column label="合同名称" style="text-align: center ;"  prop="ctBuInvoiceReqVo.contractName_" />
      <el-table-column label="发票类型" style="text-align: center ;"  prop="ctBuInvoiceReqVo.invoiceType_" >

        <template slot-scope="s">
          <p v-if="s.row.ctBuInvoiceReqVo.invoiceType_ == 1">增值税专票</p >
          <p v-if="s.row.ctBuInvoiceReqVo.invoiceType_ == 2">增值税普票</p >
        </template>
      </el-table-column>

      <el-table-column label="申请部门" style="text-align: center ;"  prop="ctBuInvoiceReqVo.reqDeptname_" />
      <el-table-column label="申请人" style="text-align: center ;"  prop="ctBuInvoiceReqVo.reqUsername_" />
      <el-table-column label="申请日期" style="text-align: center ;"  prop="ctBuInvoiceReqVo.reqDate_" />
      <el-table-column label="付款单位名称" width="150px" style="text-align: center ;"  prop="ctBuInvoiceReqVo.payerName_" />
      <el-table-column label="开票金额" style="text-align: center ;"  prop="ctBuInvoiceReqVo.invoiceAmountTax_" />

      <el-table-column label="主键" style="text-align: center ;"  v-if="show" prop="ctBuInvoiceInfoVo.ids" />
      <el-table-column label="发票代码" style="text-align: center ;"  prop="ctBuInvoiceInfoVo.invoiceCodes" />
      <el-table-column label="发票号码" style="text-align: center ;"  prop="ctBuInvoiceInfoVo.invoiceNos" />
      <el-table-column label="单据编号" style="text-align: center ;"  prop="documentNumber" />
      <el-table-column label="回款方式">
        <template slot-scope="s">
          <p v-if="s.row.paymentMethod == 1">现金</p >
          <p v-if="s.row.paymentMethod == 2">电汇</p >
          <p v-if="s.row.paymentMethod == 3">银行转账</p >
        </template>
      </el-table-column>
      <el-table-column label="回款金额" style="text-align: center ;"  prop="collectionAmount" />
      <el-table-column label="回款时间" align="center" prop="collectionTime" />
      <el-table-column label="状态">
        <template slot-scope="s">
          <p v-if="s.row.status == 0">保存</p >
          <p v-if="s.row.status == 1">审核中</p >
          <p v-if="s.row.status == 2">审核通过</p >
          <p v-if="s.row.status == 3">审核驳回</p >
        </template>
      </el-table-column>

      <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
        <template slot-scope="scope">
          <div v-if="scope.row.status >0">
            <el-button
              size="mini"
              type="text"
              icon="el-icon-edit"
              @click="addOrUpdateHandle(scope.row)"
            >审批详情
            </el-button>

<!--            <collctionDetail v-if='showcom'></collctionDetail>-->
            <el-button
              size="mini"
              type="text"
              icon="el-icon-view"
              @click="examineAndApproves (scope.row)"
            >查看流程图
            </el-button>
<!--            <div v-if="scope.row.status !=6 && scope.row.status !=4&& scope.row.status !=2&& scope.row.status !=3">-->
<!--              <el-button-->
<!--                size="mini"-->
<!--                type="text"-->
<!--                icon="el-icon-view"-->
<!--                @click="exitFlow (scope.row)"-->
<!--              >终止-->
<!--              </el-button>-->
<!--            </div>-->

          </div>
        </template>
      </el-table-column>

    </el-table>

    <pagination
      v-show="total>0"
      :total="total"
      :page.sync="queryParams.pageNum"
      :limit.sync="queryParams.pageSize"
      @pagination="getList"
    />

    <!-- 添加或修改收款单录入对话框 -->
    <el-dialog :title="title" :visible.sync="open" width="80%" append-to-body>
      <el-form ref="form" :model="form" :rules="rules" label-width="80px">

        <el-row :align="15">
          <el-col :span="8">
            <el-form-item label="收款类型" prop="payType">
              <el-select :disabled="true" v-model="form.payType" placeholder="请选择收款类型" style="width: 100%;">
                <el-option
                  v-for="dict in payTypeList"
                  :key="dict.dictValue"
                  :label="dict.dictLabel"
                  :value="dict.dictValue"
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :align="15">
          <el-col :span="8">
            <el-form-item label="项目类型" prop="approvalId">
              <el-select :disabled="true" v-model="form.approvalId" placeholder="请选择项目类型" style="width: 100%;">
                <el-option
                  v-for="dict in projectCategoryTypeList"
                  :key="dict.dictValue"
                  :label="dict.dictLabel"
                  :value="dict.dictValue"
                />
              </el-select>
            </el-form-item>
          </el-col>

          <el-col :span="8">

            <el-form-item label="项目编号" prop="proNo">
              <el-input v-model="form.ids" :readonly="true"   v-if="show"/>
              <el-input v-model="form.proNo" :readonly="true"  />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="项目名称" prop="proName">
              <el-input v-model="form.proName"  :readonly="true"    placeholder="请输入项目名称"  />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :align="15">
          <el-col :span="8">
            <el-form-item label="事前审批表ID 关联事前审批表ID" prop="contractId" v-if="show">
              <el-input v-model="form.contractId" placeholder="" />
            </el-form-item>
            <el-form-item label="合同编号"     prop="contractNo">
              <el-input v-model="form.contractNo" :readonly="true"  placeholder="请输入合同编号" />
            </el-form-item>
          </el-col>

          <el-col :span="8">
            <el-form-item
              label="合同名称"    prop="contractName">
              <el-input v-model="form.contractName" :readonly="true"  placeholder="请输入合同名称" >

                <el-button
                  slot="append"
                  icon="el-icon-search"
                  @click="getContractList"
                ></el-button>
              </el-input>
              <!--弹框-->
              <el-dialog
                width="50%"
                height="70%"
                title="合同信息"
                :visible.sync="innerhtVisible"
                append-to-body>
                <el-form
                  :model="queryParams"
                  ref="queryhtForm"
                  v-show="showSearch"
                  label-width="90px"
                >
                  <el-row >

                    <el-col :span="10">
                      <el-form-item label="合同编号" prop="contractNo">
                        <el-input
                          v-model="queryParams.contractNo"
                          placeholder="请输入合同编号"
                          clearable
                          size="small"
                          @keyup.enter.native="handlehtQuery"
                        />
                      </el-form-item>
                    </el-col>
                    <el-col :span="10">
                      <el-form-item label="合同名称" prop="contractName" >
                        <el-input
                          v-model="queryParams.contractName"
                          placeholder="请输入项目名称"
                          clearable
                          size="small"
                          @keyup.enter.native="handlesQuery"
                        />
                      </el-form-item>
                    </el-col>
                    <el-col :span="4" style="padding-left: 10px; line-height: 36px;">
                      <el-button
                        type="cyan"
                        icon="el-icon-search"
                        size="mini"
                        @click="handlehtQuery"
                      >搜索</el-button
                      >
                    </el-col>
                  </el-row>
                </el-form>
                <el-table  ref="htTable"  v-loading="htloading" :data="contractList" @selection-change="handleXmSelectionChange">
                  <el-table-column type="selection" width="55"  v-if="show"/>
                  <el-table-column label="唯一ID"  prop="id" v-if="show" />
                  <el-table-column label="唯一ID"  prop="taxrate" v-if="show"/>
                  <el-table-column label="项目类型" style="text-align: center ;"  prop="projectCategory" v-if="show"/>
                  <el-table-column label="项目编号" style="text-align: center ;"  prop="projectNo" />
                  <el-table-column label="项目名称" style="text-align: center ;"  prop="projectName" />
                  <el-table-column label="合同编号" style="text-align: center ;"  prop="contractNo" />
                  <el-table-column label="合同名称" style="text-align: center ;"  prop="contractName" />
                  <el-table-column label="操作" style="text-align: center ;"  class-name="small-padding fixed-width">
                    <!-- 单位信息 -->
                    <el-table-column label="单位名称" style="text-align: center ;"  prop="oppositeName" v-if="show"/>
                    <el-table-column label="单位地址" style="text-align: center ;"  prop="oppositeAddress" v-if="show"/>
                    <el-table-column label="纳税人识别号" style="text-align: center ;"  prop="oppositeCreditCode" v-if="show"/>
                    <el-table-column label="单位电话" style="text-align: center ;"  prop="oppositePhone" v-if="show"/>
                    <el-table-column label="单位开户行" style="text-align: center ;"  prop="oppositeBank" v-if="show"/>
                    <el-table-column label="项目类型" style="text-align: center ;"  prop="projectCategory" v-if="show"/>
                    <el-table-column label="合同类别" style="text-align: center ;"  prop="contractCategory" v-if="show"/>
                    <el-table-column label="合同类别名称" style="text-align: center ;"  prop="contractCategoryName" v-if="show"/>


                    <el-table-column label="单位账号" style="text-align: center ;"  prop="oppositeBankId" v-if="show"/>
                    <template slot-scope="scope">
                      <el-button
                        size="mini"
                        type="text"
                        icon="el-icon-edit"
                        @click="submithtForm(scope.row)"

                      >选择</el-button>

                    </template>
                  </el-table-column>
                </el-table>
                <pagination
                  v-show="total>0"
                  :total="total"
                  :page.sync="queryParams.pageNum"
                  :limit.sync="queryParams.pageSize"
                  @pagination="contractList"
                />
                <div slot="footer" class="dialog-footer">
                  <!-- <el-button type="primary" @click="submithtForm">确 定</el-button> -->
                  <el-button @click="innerhtVisible=false">取 消</el-button>
                </div>

              </el-dialog>



            </el-form-item>
          </el-col>
          <el-form-item label="发票ID" prop="invoiceId"  v-if="show">
            <el-input v-model="form.invoiceId" placeholder="请输入发票ID" />
          </el-form-item>
          <el-col :span="8">
            <el-form-item label="发票代码" prop="invoiceCode">
              <el-input v-model="form.invoiceCode" :readonly="true"  placeholder="请输入发票代码" />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :align="15">
          <el-col :span="8">
            <el-form-item label="发票号码" prop="invoiceNo">
              <el-input v-model="form.invoiceNo" :readonly="true"  placeholder="请输入发票号码" />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="回款时间" prop="collectionTime">
              <el-date-picker clearable size="small" :style="{ width: '100%' }"
                              v-model="form.collectionTime"
                              type="date"
                              value-format="yyyy-MM-dd"
                              placeholder="选择回款时间">
              </el-date-picker>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="回款金额" prop="collectionAmount">
              <el-input v-model="form.collectionAmount" readOnly="true" placeholder="请输入回款金额" oninput="value=value.replace(/[^0-9.]/g,'')" />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :align="15">
          <el-col :span="8">
            <el-form-item label="单据编号" prop="documentNumber">
              <el-input v-model="form.documentNumber" placeholder="请输入单据编号" />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="回款方式" prop="paymentMethod">

              <el-select :style="{ width: '100%' }"
                         v-model="form.paymentMethod"
                         placeholder="合同类别"
              >
                <el-option
                  v-for="dict in collectMethodList"
                  :key="dict.dictValue"
                  :label="dict.dictLabel"
                  :value="dict.dictValue"
                />
              </el-select>

            </el-form-item>
          </el-col>
          <el-form-item label="状态" v-if="show">
            <el-radio-group v-model="form.status">
              <el-radio label="1">请选择字典生成</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item label="状态说明" prop="statusps"  v-if="show">
            <el-input v-model="form.statusps" placeholder="请输入状态说明" />
          </el-form-item>
          <el-form-item label="删除标志" prop="delFlag"  v-if="show">
            <el-input v-model="form.delFlag" placeholder="请输入删除标志" />
          </el-form-item>
          <el-form-item label="备注" prop="remark"  v-if="show">
            <el-input v-model="form.remark" type="textarea" placeholder="请输入内容" />
          </el-form-item>
          <el-col :span="8">
            <el-form-item label="银行单据" prop="voucher">
              <el-upload
                :disabled="authenStatus"
                ref="field101"
                :file-list="voucher"
                :action="field101Action"
                :headers="token"
                :on-success="contractApprovalFileSuccess"
                :on-remove="removeContractApprovalFile"
                :auto-upload="autoUploadFalg"
                multiple
                :limit="20"
                :before-upload="field101BeforeUpload"
                :on-preview="handlePictureCardPreview"
              >
                <el-button slot="trigger" size="small" type="primary" :disabled="authenStatus">选取文件</el-button>

              </el-upload>
            </el-form-item>
          </el-col>
        </el-row>


      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="primary"  v-if="butVis" @click="submitForm(0)">保 存</el-button>
        <el-button type="primary"  v-if="butVis" @click="submitForm(1)">提 交</el-button>
        <el-button @click="cancel">取 消</el-button>
      </div>
    </el-dialog>

    <AddorUpdate v-if="addOrUpdateVisible" ref="addOrUpdate"></AddorUpdate>
  </div>
</template>

<script>
  import { listFinancialList ,listReceiptInfo, getReceiptInfo, delReceiptInfo, addReceiptInfo, updateReceiptInfo, exportReceiptInfo } from "@/api/collection/receiptInfo";
  import { listApplyCollection,detailNgcApproval,findContract,detailhtCon,getUserInfo  } from "@/api/collection/common";
  import { listFinancial } from "@/api/collection/voucher";
  import { getToken } from "@/utils/auth";
  import { findProjectType, findBranchOffice, delFileById, findFileListByPid, findFileListByPidPtype, downloadfileById} from "@/api/utils";
  import AddorUpdate from './detail.vue';
  export default {
    name: "ReceiptInfo",
    components: {
      AddorUpdate
    },
    data() {
      return {
        showcom:true,
        //项目类型
        addOrUpdateVisible:false,
        authenStatus:false,
        voucher:[],
        uploadVis:true,
        dialogVisible:false,
        dialogImageUrl:null,
        butVis:true,
        autoUploadFalg: true,
        field101Action: "/dev-api/dictionary/fileManage/addSaveFile",
        token: {},
        //收款类型
        payTypeList:[],
        // 财务开票表格数据
        financialList: [],
        projectCategoryTypeList:[],
        //回款方式
        collectMethodList:[],
        show: false,
        innerVisible: false,
        innerhtVisible: false,
        loadings:false,
        // 遮罩层
        loading: true,
        // 项目信息列表
        projectList: [],
        // 选中数组
        ids: [],
        // 非单个禁用
        single: true,
        // 非多个禁用
        multiple: true,
        innerhtVisible: false,
        // 显示搜索条件
        showSearch: true,
        // 总条数
        total: 0,
        // 收款单录入表格数据
        receiptInfoList: [],
        contractList:[],
        // 弹出层标题
        title: "",
        // 是否显示弹出层
        htloading:true,
        open: false,
        statusList:[],
        // 查询参数
        queryParams: {
          pageNum: 1,
          pageSize: 10,
          approvalId: null,
          proNo: null,
          proName: null,
          contractId: null,
          contractNo: null,
          contractName: null,
          invoiceId: null,
          invoiceCode: null,
          invoiceNo: null,
          collectionTime: null,
          collectionAmount: null,
          documentNumber: null,
          paymentMethod: null,
          voucher: null,
          status: null,
          statusps: null,

        },
        // 表单参数
        form: {},
        // 表单校验
        rules: {
          payType: [{ required: true, message: '请选择收款类型', trigger: 'blur' }],
          approvalId: [{ required: true, message: '请选择项目类型', trigger: 'blur' }],
          proNo: [{ required: true, message: '项目编号不能为空', trigger: 'blur' }],
          proName: [{ required: true, message: '项目名称不能为空', trigger: 'blur' }],
          contractNo: [{ required: true, message: '合同编号不能为空', trigger: 'blur' }],
          contractName: [{ required: true, message: '合同名称不能为空', trigger: 'blur' }],
          invoiceCode: [{ required: true, message: '发票代码不能为空', trigger: 'blur' }],
          invoiceNo: [{ required: true, message: '发票号码不能为空', trigger: 'change' }],
          collectionTime: [{ required: true, message: '回款时间不能为空', trigger: 'change' }],
          collectionAmount: [{ required: true, message: '回款金额不能为空', trigger: 'change' }],
          documentNumber: [{ required: true, message: '单据编号不能为空', trigger: 'change' }],
          paymentMethod: [{ required: true, message: '回款方式不能为空', trigger: 'change' }],
          voucher:[{
            required: true,
            message: '请上传银行单据',
            trigger: 'change'
          }]
        }
      };
    },
    created() {
      this.getList();
      //项目类型列表
      this.getDicts("project_category_type").then((response) => {
        this.approvalTypeOptions = response.data;
        this.projectCategoryTypeList = response.data;
      });
      //项目类型列表
      this.getDicts("pay_method").then((response) => {
        this.collectMethodList = response.data;
      });
      //收款类型列表
      this.getDicts("sys_pay_type").then((response) => {
        this.approvalTypeOptions = response.data;
        this.payTypeList = response.data;
      });
    },
    methods: {
      addOrUpdateHandle(id){
        this.addOrUpdateVisible = true
        this.$nextTick(() =>{
          this.$refs.addOrUpdate.init(id);
        })
      },
      /** 查看流程图 */
      examineAndApproves(row) {
        this.reset();
        let url = window.location.hostname;
        if(url.indexOf("http")<0){
          url = "http://"+url;
        }
        let hosturl = url+":9001/task/exportImage?processInstanceId="+row.instanceId;
        window.open(hosturl,"_blank");
      },
      // 表单重置
      resetQuerys() {
        this.queryParams = {
          id: null,
          contractCategory: null,
          reqId: null,
          invoiceCode: null,
          invoiceNo: null,
          invoiceDate: null,
          invoiceDrawer: null,
          invoiceReviewer: null,
          invoicePayee: null,
          invoiceAmountTax: null,
          invoiceTaxrate: null,
          invoiceAmountNtax: null,
          invoiceImg: null,
          companyImg: null,
          handoverUserid: null,
          handoverUsername: null,
          handoverTime: null,
          confirmerUserid: null,
          confirmerUsername: null,
          confirmerTime: null,
          voucherNo: null,
          voucherUserid: null,
          voucherUsername: null,
          voucherTime: null,
          status: 0,
          statusps: null,
          delFlag: null,
          remark: null,
          createBy: null,
          createTime: null,
          updateBy: null,
          updateTime: null
        };
        this.resetForm("queryParams");
        this.getList();
      },
      handlePictureCardPreview(file) {//点击放大图片
        if((file.url).indexOf("profile")>=0){
          let files = (file.url).split("profile");
          let url = window.location.hostname;
          if(url.indexOf("http")<0){
            url = "http://"+url;
          }
          // var url_ = url+":9001/profile"+files[1];
          window.open(url+":9001/dictionary/fileManage/dwonLoadFile/"+file.uid+'/'+file.ptype);
        }
      },
      /** 文件上传检测 **/
      field101BeforeUpload(file) {
        let isRightSize = file.size / 1024 / 1024 < 2;
        if (!isRightSize) {
          this.$message.error('文件大小超过 2MB');
        }
        return isRightSize;
      },
      /** 上传附件成功操作 **/
      contractApprovalFileSuccess(res, file, fileList) {
        for (let index = 0; index < fileList.length; index++) {
          const element = fileList[index];
          if (element.uid == file.uid) {
            element.uid = res.msg;
          }
        }
        if (this.form.voucher) {
          this.form.voucher += res.msg + ",";
        } else {
          this.form.voucher = res.msg + ",";
        }
        this.$refs.form.validateField("voucher");
      },
      /** 删除附件操作 **/
      removeContractApprovalFile(file, fileList) {
        delFileById(file.uid).then(response => {
          if (response.code == 200) {
            this.form.voucher = null;
            for (let index = 0; index < fileList.length; index++) {
              const element = fileList[index];
              if (this.form.voucher) {
                this.form.voucher += element.uid + ",";
              } else {
                this.form.voucher = element.uid + ",";
              }
            }
          }
        });
      },
      handleRemove(file, fileList) {
        console.log(file, fileList);
      },
      handlePreview(file) {
        console.log(file);
      },
      handleExceed(files, fileList) {
        this.$message.warning(`当前限制选择 3 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
      },
      beforeRemove(file, fileList) {
        return this.$confirm(`确定移除 ${ file.name }？`);
      },

// 多选框选中数据
      handleXmSelectionChange(val) {
        this.ids = val.map(item => item.id)
        this.statusList =  val.map(item => item.status)
        if (val.length > 1) {
          this.$refs.Table.clearSelection()
          this.$refs.Table.toggleRowSelection(val.pop())
        } else {
        }

      },
      /** 搜索按钮操作 */
      handlesQuery() {
        this.queryParams.pageNum = 1;
        this.getApplyList();
      },
      /** 搜索按钮操作 */
      handlehtQuery() {
        this.queryParams.pageNum = 1;
        this.getContractList();
      },
//获取项目信息
      getApplyList() {
        this.projectList = [];
        this.loadings = true;
        this.innerVisible = true;
        this.queryParams.pageNum = 1;
        this.apptype=this.form.approvalId;
        //  this.queryParams.approvalType = this.form.approvalType;
        listApplyCollection(this.form.approvalId,this.addDateRange(this.queryParams, this.dateRange)).then(response => {
          this.total = response.total;
          if(this.total==0){
            this.projectList = [];
          }else{
            this.projectList = response.rows;
          }


          this.loadings = false;

          this.innerVisible = true;
          this.title = "修改发票申请";
          this.apptype=this.form.approvalId;
        });
      },
      //获取合同信息
      getContractList() {
        this.htloading = true;
        this.innerhtVisible = true;
        this.queryParams.projectId = (this.form.approvalId);
        console.log(this.queryParams);
        this.queryParams={};
        this.queryParams.status = 2;
        findContract(this.addDateRange(this.queryParams, this.dateRange)).then(response => {
          this.contractList = response.rows;
          this.total = response.total;
          this.htloading = false;
          this.innerhtVisible = true;
        });
      },
      /** 查询收款单录入列表 */
      getList() {
        this.loading = true;
        this.queryParams.status = 1;
        this.queryParams.createBy = '';
        listFinancialList(this.queryParams).then(response => {
          console.log("fpsq");
          console.log(response);
          this.financialList = response.rows;
          this.total = response.total;
          this.loading = false;
        });
        // this.loading = true;
        // listReceiptInfo(this.queryParams).then(response => {
        //   this.receiptInfoList = response.rows;
        //   this.total = response.total;
        //   this.loading = false;
        // });
      },
      // 取消按钮
      cancel() {
        this.open = false;
        this.reset();
      },
      cancelAppri() {
        this.innerVisible = false;
        this.form.reqNo = null;
        this.form.proName = null;
      },
      /** 修改按钮操作 */
      submitsForm(row) {
        const id = row.id || this.ids;
        detailNgcApproval(this.apptype,id).then(response => {
          this.form.approvalId=id;
          this.form.proNo=response.data.reqNo;
          this.form.proName=response.data.proName;
          this.innerVisible = false;
        });
      },
      /** 选择合同 */
      submithtForm(row) {
        const id = row.id || this.ids;
        this.taxrate = row.taxrate;
        this.form.contractId=row.id;
        this.form.contractNo=row.contractNo;
        this.form.contractName=row.contractName;
        //项目信息
        this.form.approvalId=row.projectCategory+"";
        this.form.proNo=row.projectNo;
        this.form.proName=row.projectName;
        // if( this.form.approvalType==''){
        //   this.form.approvalType=row.projectCategory;
        // }
        this.form.payerName = row.oppositeName;
        this.form.payerAddress = row.oppositeAddress;
        this.form.creditCode = row.oppositeCreditCode;
        this.form.payerPhone = row.oppositePhone;
        this.form.payerOpeningBank = row.oppositeBank;
        this.form.payerAccount = row.oppositeBankId;

        // this.form.approvalType = row.projectCategory;
        this.form.contractCategoryName = row.contractCategoryName;
        this.form.contractCategory = row.contractCategory;
        this.innerhtVisible = false;


      },
      // 表单重置
      reset() {
        this.form = {
          id: null,
          approvalId: null,
          proNo: null,
          proName: null,
          contractId: null,
          contractNo: null,
          contractName: null,
          invoiceId: null,
          invoiceCode: null,
          invoiceNo: null,
          collectionTime: null,
          collectionAmount: null,
          documentNumber: null,
          paymentMethod: null,
          voucher: null,
          status: 0,
          statusps: null,
          delFlag: null,
          remark: null,
          createBy: null,
          createTime: null,
          updateBy: null,
          updateTime: null
        };
        this.resetForm("form");
      },
      /** 搜索按钮操作 */
      handleQuery() {
        this.queryParams.pageNum = 1;
        this.getList();
      },
      /** 重置按钮操作 */
      resetQuery() {
        this.resetForm("queryForm");
        this.handleQuery();
      },
      resetForm() {
        //  this.form.resetFields();
        /** 加入请求头 **/
        this.token = { Authorization: getToken() };
      },
      // 多选框选中数据
      handleSelectionChange(selection) {
        this.ids = selection.map(item => item.id)
        this.statusList = selection.map(item => item.status)
        this.single = selection.length!==1
        this.multiple = !selection.length
      },
      /** 新增按钮操作 */
      handleAdd() {
        this.reset();
        this.open = true;
        this.title = "添加收款单录入";
      },
      /** 修改按钮操作 */
      handleUpdate(row) {
        this.reset();
        let id = row.id || this.ids
        let approvalId_ = '';
        let proName_ ='';
        let proNo_ = '';
        let contractId_ = '';
        let contractNo_='';
        let contractName_='';
        let invoiceId_='';
        let invoiceCode_='';
        let invoiceNo_='';
        this.form.payType = 2+"";
        this.form.payTypeName="发票付款";
        if(id==''){
          const _selectData = this.$refs.financialList.selection;
            if(_selectData.length>1){
              this.msgError("只能选择一条记录");
              return false;
            }
            let status = _selectData[0].status;
            if(status==1 || status==2){
              this.butVis = false;
              this.uploadVis = false;
              this.authenStatus = true;
            }
            this.queryParams.status = 1;
            this.queryParams.id_ = _selectData[0].ctBuInvoiceReqVo.id_;

            listFinancialList(this.queryParams).then(response => {
              this.token = { Authorization: getToken() };
              this.form.approvalId = (response.rows[0].ctBuInvoiceReqVo.approvalType_)+'';
              this.form.proNo = response.rows[0].ctBuInvoiceReqVo.proNo_;
              this.form.proName = response.rows[0].ctBuInvoiceReqVo.proName_;
              this.form.contractId = response.rows[0].ctBuInvoiceReqVo.contractId_;
              this.form.contractNo = response.rows[0].ctBuInvoiceReqVo.contractNo_;
              this.form.contractName = response.rows[0].ctBuInvoiceReqVo.contractName_;
              // this.form.invoiceId = response.rows[0].ctBuInvoiceReqVo.id_;
              this.form.invoiceId = response.rows[0].ctBuInvoiceInfoVo.ids;
              this.form.invoiceCode = response.rows[0].ctBuInvoiceInfoVo.invoiceCodes;
              this.form.invoiceNo =response.rows[0].ctBuInvoiceInfoVo.invoiceNos;
              this.form.ids =response.rows[0].ctBuInvoiceInfoVo.ids;
              this.open = true;
              this.form.collectionAmount = response.rows[0].ctBuInvoiceReqVo.invoiceAmountTax_;
              this.title = "收款单录入";

            });
        }else{
          getReceiptInfo(id).then(response => {
            this.form = response.data;
            this.open = true;
            this.title = "收款单录入";

            let status = response.data.status;
            if(status==1 || status==2){
              this.butVis = false;
              this.uploadVis = false;
              this.authenStatus = true;
            }
          });
        }

        /** 获取文件列表 **/
        if(id!='' && id!=null){
          findFileListByPidPtype(id,1).then(response => {
            this.voucher= response.data;
          });
        }
      },
      /** 提交按钮 */
      submitForm(val) {
        this.$refs["form"].validate(valid => {
          if (valid) {
            this.form.payType=2;
            this.form.payTypeName="发票收款";
            this.form.status=val;
            if (this.form.id != null) {
              updateReceiptInfo(this.form).then(response => {
                this.msgSuccess("修改成功");
                this.open = false;
                this.getList();
              });
            } else {
              addReceiptInfo(this.form).then(response => {
                this.msgSuccess("新增成功");
                this.open = false;
                this.getList();
              });
            }
          }
        });
      },
      /** 删除按钮操作 */
      handleDelete(row) {
        const ids = row.id || this.ids;
        const status = row.status || this.statusList;
        if(status!=null && status.length>0){
          for(let item  of status){
            if(item>0){
              this.msgError("请删除为提交数据");
              return false;
            }
          }
        }
        this.$confirm('是否确认删除选中的数据?', "警告", {
          confirmButtonText: "确定",
          cancelButtonText: "取消",
          type: "warning"
        }).then(function() {
          return delReceiptInfo(ids);
        }).then(() => {
          this.getList();
          this.msgSuccess("删除成功");
        })
      },
      /** 导出按钮操作 */
      handleExport() {
        const queryParams = this.queryParams;
        this.$confirm('是否确认导出所有收款单录入数据项?', "警告", {
          confirmButtonText: "确定",
          cancelButtonText: "取消",
          type: "warning"
        }).then(function() {
          return exportReceiptInfo(queryParams);
        }).then(response => {
          this.download(response.msg);
        })
      }
    }
  };
</script>
