<template>
  <div class="app-container">
    <el-form
      :model="queryParams"
      ref="queryForm"
      v-show="showSearch"
      label-width="90px"
    >
      <el-row :gutter="15">
        <el-col :span="6">
          <el-form-item label="所属分公司" prop="belongCompanyid">
            <el-select
              style="width:100%;"
              v-model="queryParams.belongCompanyid"
              placeholder="请输入所属分公司"
              clearable
              @clear="remove()"
              size="small"
            >
              <el-option
                v-for="dict in belongCompanyNameList"
                :key="dict.deptId"
                :label="dict.deptName"
                :value="dict.deptId"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item label="所属部门" prop="belongDeptid">
            <input type="hidden" v-model="queryParams.belongDeptid" />
            <el-input
              placeholder="请选择所属部门"
              v-model="queryParams.belongDeptName"
            >
              <el-button
                slot="append"
                icon="el-icon-search"
                @click="clickChoiceDept()"
              ></el-button>
            </el-input>
            <el-dialog
              title="选择所属部门"
              :visible.sync="depDialog"
              width="30%"
              :before-close="handleClose"
            >
              <selectDep ref="selectDep"></selectDep>
              <span slot="footer" class="dialog-footer">
                <el-button @click="depDialog = false">取 消</el-button>
                <el-button type="primary" @click="choiceDept()"
                  >确 定</el-button
                >
              </span>
            </el-dialog>
            <!-- <treeselect
              v-model="queryParams.belongDeptid"
              :options="deptOptions"
              :show-count="false"
              placeholder="请选择所属部门"
              size="small"
            /> -->
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item label="申请编号" prop="reqNo">
            <el-input
              v-model="queryParams.reqNo"
              placeholder="请输入申请编号"
              clearable
              size="small"
              @keyup.enter.native="handleQuery"
            />
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item label="项目名称" prop="proName">
            <el-input
              v-model="queryParams.proName"
              placeholder="请输入项目名称"
              clearable
              size="small"
              @keyup.enter.native="handleQuery"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="15">
        <el-col :span="6">
          <el-form-item label="项目类型" prop="proType">
            <el-select
              style="width:100%;"
              v-model="queryParams.proType"
              placeholder="请选择项目类型"
              clearable
              size="small"
            >
              <el-option
                v-for="dict in proTypeNameList"
                :key="dict.id"
                :label="dict.typeName"
                :value="dict.id"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item label="状态" prop="status">
            <el-select
              style="width:100%;"
              v-model="queryParams.status"
              placeholder="请选择状态"
              clearable
              size="small"
            >
              <el-option
                v-for="dict in collectTypeOptions"
                :key="dict.dictValue"
                :label="dict.dictLabel"
                :value="dict.dictValue"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="6">
          <el-form-item>
            <el-button
              type="cyan"
              icon="el-icon-search"
              size="mini"
              @click="handleQuery"
              >搜索</el-button
            >
            <el-button icon="el-icon-refresh" size="mini" @click="resetQuery"
              >重置</el-button
            >
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>
    <el-row :gutter="10" class="mb8">
      <el-col :span="1.5"
        ><el-button
          type="primary"
          icon="el-icon-plus"
          size="mini"
          @click="handleAdd"
          v-hasPermi="['projectApproval:collectProject:add']"
          >新增</el-button
        ></el-col
      >
      <el-col :span="1.5">
        <el-button
          type="success"
          icon="el-icon-edit"
          size="mini"
          :disabled="single"
          @click="handleUpdate"
          v-hasPermi="['projectApproval:collectProject:edit']"
          >修改</el-button
        >
      </el-col>
      <el-col :span="1.5">
        <el-button
          type="danger"
          icon="el-icon-delete"
          size="mini"
          :disabled="multiple"
          @click="handleDelete"
          v-hasPermi="['projectApproval:collectProject:remove']"
        >
          删除
        </el-button>
      </el-col>
      <el-col :span="1.5">
        <el-button
          type="warning"
          icon="el-icon-download"
          size="mini"
          @click="handleExport"
          v-hasPermi="['projectApproval:collectProject:export']"
          >导出</el-button
        >
      </el-col>
      <right-toolbar
        :showSearch.sync="showSearch"
        @queryTable="getList"
      ></right-toolbar>
    </el-row>

    <el-table
      v-loading="loading"
      :data="collectProjectList"
      ref="itsmDataTable" border
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" width="55px" align="center" />
      <el-table-column label="唯一ID" align="center" prop="id" v-if="show" />
      <el-table-column label="申请编号" align="center" prop="reqNo" />
      <el-table-column label="项目名称" align="center" prop="proName" width="180px"/>
      <el-table-column label="项目类型" align="center" prop="proTypeName" width="100px"/>
      <el-table-column
        label="所属分公司"
        align="center"
        prop="belongCompanyName"
      />
      <el-table-column label="所属部门" align="center" prop="belongDeptName" width="100px"/>
      <el-table-column
        label="合同金额"
        align="center" width="100px"
        prop="contractAmountTotal"
        clearable
      />
      <el-table-column label="状态说明" align="center" prop="statusPs" width="100px"/>
      <el-table-column
        label="操作"
        align="center"
        class-name="small-padding fixed-width"
      >
        <template slot-scope="scope">
          <el-button
            size="mini"
            type="text"
            icon="el-icon-edit"
            @click="handleUpdate(scope.row)" v-if="scope.row.status==0 || scope.row.status==3"
            v-hasPermi="['projectApproval:collectProject:edit']"
            >修改</el-button
          >
          <el-button
            size="mini"
            type="text"
            icon="el-icon-delete"
            @click="handleDelete(scope.row)" v-if="scope.row.status==0 || scope.row.status==3"
            v-hasPermi="['projectApproval:collectProject:remove']"
            >删除</el-button
          >
          <el-button
            size="mini"
            type="text"
            icon="el-icon-view" v-if="scope.row.status>0"
            @click="examineAndApprove(scope.row)"
          >审批详情
          </el-button>
          <el-button
            size="mini"
            type="text"
            icon="el-icon-view" v-if="scope.row.status>0"
            @click="examineAndApproves(scope.row)"
          >查看流程图
          </el-button>

        </template>
      </el-table-column>
    </el-table>
    <pagination
      v-show="total > 0"
      :total="total"
      :page.sync="queryParams.pageNum"
      :limit.sync="queryParams.pageSize"
      @pagination="getList"
    />
    <!-- 添加或修改事前审批主(集客类)对话框 -->
    <el-dialog
      :title="title"
      :visible.sync="open"
      width="80%"
      @close="closeUserAdd()"
    >
      <el-form
        ref="form"
        :model="form"
        size="medium"
        :rules="rules"
        label-width="90px"
      >
        <el-row :gutter="15">
          <el-col :span="6">
            <el-form-item label="分公司名称" prop="belongCompanyid">
              <el-select
                v-model="form.belongCompanyid"
                placeholder="请输入分公司"
                @change="getDept($event)"
                :disabled="choise"
                style="width: 100%;"
              >
                <el-option
                  v-for="dict in belongCompanyNameList"
                  :key="dict.deptId"
                  :label="dict.deptName"
                  :value="dict.deptId"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="所属部门" prop="belongDeptid">
              <treeselect
                v-model="form.belongDeptid"
                :options="deptOptions"
                :show-count="false"
                placeholder="请选择所属部门"
              />
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="项目类型" prop="proType">
              <el-select
                v-model="form.proType"
                placeholder="请选择项目类型"
                style="width: 100%;"
              >
                <el-option
                  v-for="dict in proTypeNameList"
                  :key="dict.id"
                  :label="dict.typeName"
                  :value="dict.id"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="项目名称" prop="proName">
              <el-input v-model="form.proName" placeholder="请输入项目名称" />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="15">
          <el-col :span="6">
            <el-form-item label="合同金额" prop="contractAmountTotal">
              <el-input
                v-model="form.contractAmountTotal"
                v-on:input="changeNum()"
                clearable
                placeholder="请输入合同金额"
              />
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="税率(%)" prop="taxrate">
              <el-input
                v-model="form.taxrate"
                v-on:input="changeNum()"
                placeholder="请输入税率"
              />
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="不含税额" prop="contractAmountTax">
              <el-input
                v-model="form.contractAmountTax"
                placeholder="请输入不含税金额"
                :disabled="true"
              />
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="税额" prop="taxamount">
              <el-input
                v-model="form.taxamount"
                placeholder="请输入税额"
                :disabled="true"
              />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="24">
            <el-form-item label="涉及分公司">
              <el-select
                v-model="form.selectComp"
                multiple
                placeholder="请选择"
                :style="{ width: '100%' }"
                @change="refreshComp()"
              >
                <el-option
                  v-for="dict in belongCompanyNameList"
                  :key="dict.deptId"
                  :label="dict.deptName"
                  :value="dict.deptId"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="24">
            <table class="curr-table " border="1" style="border-color: #ddd;">
              <tbody>
                <tr>
                  <th width="10%">序号</th>
                  <th width="75%">已选分公司</th>
                  <th width="15%">操作</th>
                </tr>
                <tr v-for="(value, index) in form.selectComp" :key="index">
                  <td align="center">
                    {{ index+1 }}
                  </td>
                  <td align="center">
                    {{value}}
                  </td>
                  <td align="center">
                    <el-button
                      size="mini"
                      type="success"
                      @click="openInfoWin()"
                      style="margin: 10px;"
                      >填写信息</el-button>
                  </td>
                </tr>
                </tbody>
            </table>
          </el-col>
        </el-row>
       <!-- 编辑分公司信息的内部嵌套窗口 -->
        <el-dialog title="编辑信息"
        :visible.sync="editInfoVisible"
        width="80%"
        append-to-body
        @close="">
          <el-tabs v-model="activeName">
             <el-tab-pane label="基本信息" name="base" prop="appNgBase">
               <basicInfo
                 ref="basicInfo"
                 :baseInfoDate="form.appNgBase"
               ></basicInfo>
             </el-tab-pane>
             <el-tab-pane label="材料信息" name="second" prop="appNgMaterialList"
               ><materialsInfo
                 ref="materialsInfo"
                 :materialsInfoDate="form.appNgMaterialList"
               ></materialsInfo
             ></el-tab-pane>
             <el-tab-pane label="施工费信息" name="third" prop="appNgConstList"
               ><construcostInfo
                 ref="construcostInfo"
                 :construcostInfoDate="form.appNgConstList"
               ></construcostInfo
             ></el-tab-pane>
             <el-tab-pane label="事前审批表" name="fourth" prop="appxNgReq"
               ><approvalInfo
                 ref="approvalInfo"
                 :approvalInfoDate="form.appxNgReq"
                 :appxNgName="form.proName"
                 :proType="form.proType"
               ></approvalInfo
             ></el-tab-pane>
           </el-tabs>
        </el-dialog>

      </el-form>
      <div slot="footer" class="dialog-footer"  v-if="butVis">
        <el-button type="success" @click="submitForm(0)">保 存</el-button>
        <el-button type="primary" @click="submitOne(1)">提 交</el-button>
        <el-button @click="cancel">取 消</el-button>
      </div>
      <div v-if="audit">
        <el-row :gutter="15">
            <el-col :span="24" >
              <el-divider content-position="center" ><el-link type="primary"><b>审核信息</b></el-link></el-divider>
            </el-col>
          </el-row>
        <el-row :gutter="15">
            <el-table :data="tableData_">
              <el-table-column label="任务节点" prop="taskNodeName" header-align="center" align="center">
              </el-table-column>
              <el-table-column label="审批人" prop="createName" header-align="center" align="center">
              </el-table-column>
              <el-table-column label="审批意见" prop="controlValue" header-align="center" align="center">
              </el-table-column>
              <el-table-column label="审批时间" prop="createTime"   header-align="center" align="center">
              </el-table-column>
            </el-table>
          </el-row>
        </div>
    </el-dialog>


    <!-- 对话框 -->
    <el-dialog
      :title="title_"
      :visible.sync="open_"
      width="67%"
      append-to-body
      @close="closeUserAdd()"
    >
      <el-form
        ref="form"
        :model="form"
        size="medium"
        label-width="90%"
      >
          <el-table
              ref="multipleTable"
              :data="tableData"
              tooltip-effect="dark"
              style="width: 100%"
              @selection-change="handleSelectionChange_">
              <el-table-column
                type="selection"
                width="55">
              </el-table-column>
              <el-table-column
                label="序号"
                width="120">
                <template slot-scope="scope">{{ scope.row.num }}</template>
              </el-table-column>
              <el-table-column
                label="项目"
                width="800px">
                <template slot-scope="scope">{{ scope.row.xm }}</template>
              </el-table-column>

            </el-table>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="primary" @click="submitFormPar(1)">提 交</el-button>
        <el-button @click="cancelPar">取 消</el-button>
      </div>
    </el-dialog>

  </div>
</template>

<script>
import {
  listCollectProject,
  getCollectProject,
  delCollectProject,
  addCollectProject,
  updateCollectProject,
  exportCollectProject,
  getUserInfo
} from "@/api/projectApproval/collectProject";

import {
  findProjectType,
  findBranchOffice,
  findLoginbyCompany,
  findNextAppNo,
  findDeptByBranchOffice
} from "@/api/utils";

import { treeselect } from "@/api/system/dept";
import Treeselect from "@riophae/vue-treeselect";
import "@riophae/vue-treeselect/dist/vue-treeselect.css";
import basicInfo from "./basicInfo.vue";
import materialsInfo from "./materialsInfo.vue";
import construcostInfo from "./construcostInfo.vue";
import approvalInfo from "./approvalInfo";
import selectDep from "./selectDep";


export default {

  name: "CollectProject",
  components: {
    Treeselect,
    basicInfo,
    materialsInfo,
    construcostInfo,
    approvalInfo,
    selectDep
  },
  props: {},
  data() {
    return {
       butVis:false,
       audit:false,
       tableData_:[],
       ngAudit:false,

       tableData: [{
                num: 1,
                xm: '三重一大项目或预算投资金额≥50万元'
              }, {
                 num: 2,
                xm: '针对跨区项目，涉及网络自主建设或技术平台建设及应用，预计项目金额≥10万元 或 5万元≤投资额＜50万元'
              }, {
                 num: 3,
                xm: '针对非跨区项目，涉及网络自主建设或技术平台建设及应用，预计项目金额≥10万元 或 5万元≤投资额＜50万元'
              }, {
                 num: 4,
                xm: '针对不涉及网络自主建设或技术平台建设及应用，预计项目金额≥10万元（非垫资）'
              }, {
                 num: 5,
                xm: '针对框架类协议业务点位新增、小集客业务政策申请、预计项目金额＜10万元 或 投资额＜5万元的项目'
              }],


      choise:false,
      open_:false,
      depDialog: false, //选择所属部门窗口
      activeName: "base",
      // 遮罩层
      loading: true,
      baseFormData: Object,
      // 选中数组
      ids: [],
      show: false,
      // 非单个禁用
      single: true,
      // 非多个禁用
      multiple: true,
      // 显示搜索条件
      showSearch: true,
      // 总条数
      total: 0,
      // 表格数据
      collectProjectList: [],
      collectTypeOptions: [],
      proTypeNameList: [],
      belongCompanyNameList: [], //所属分公司
      // 部门树选项
      deptOptions: [],
      // 弹出层标题
      title: "",
      title_: "",
      // 是否显示弹出层
      open: false,
      editInfoVisible:false,  //信息编辑窗口
      // 查询参数
      queryParams: {
        pageNum: 1,
        pageSize: 10,
        reqNo: null,
        proName: null,
        proType: null,
        proTypeName: null,
        belongCompanyid: null,
        belongCompanyName: null,
        belongDeptid: null,
        belongDeptName: null,
        contractAmountTotal: null,
        contractAmountTax: null,
        taxrate: null,
        taxamount: null,
        status: null
      },
      // 表单参数
      form: {
        id: null,
        createBy: null,
        createTime: null,
        updateBy: null,
        updateTime: null,
        reqNo: null,
        proName: null,
        proType: null,
        proTypeName: null,
        belongCompanyid: null,
        belongCompanyName: null,
        belongDeptid: null,
        belongDeptName: null,
        contractAmountTotal: null,
        contractAmountTax: null,
        taxrate: null,
        taxamount: null,
        status: 0,
        statusPs: null,
        remarks: null,
        delFlag: null,
        appNgBase: null,
        appNgMaterialList: [],
        appNgConstList: [],
        appxNgReq: [],
        instanceType:null,
        selectComp:[]
      },
      // 表单校验
      rules: {
        contractAmountTotal: [
          {
            required: true,
            message: "请输入合同金额",
            trigger: "blur"
          },
          {
            pattern: /(^[1-9](\d+)?(\.\d{1,2})?$)|(^[1-9]$)|(^\d\.[1-9]{1,2}$)|(^\d\.[0]{1}[1-9]{1}$|(^\d\.[1-9]{1}[0]{1}$)$)/,
            message: "请正确输入合同金额",
            trigger: "blur"
          }
        ],
        taxrate: [
          {
            required: true,
            message: "请输入税率",
            trigger: "blur"
          },
          {
            pattern: /(^[1-9](\d+)?(\.\d{1,2})?$)|(^[1-9]$)|(^\d\.[1-9]{1,2}$)|(^\d\.[0]{1}[1-9]{1}$|(^\d\.[1-9]{1}[0]{1}$)$)/,
            message: "请正确输入税率",
            trigger: "blur"
          }
        ],
        taxamount: [
          {
            required: true,
            message: "请输入税额",
            trigger: "blur"
          },
          {
            pattern: /(^[1-9](\d+)?(\.\d{1,2})?$)|(^[1-9]$)|(^\d\.[1-9]{1,2}$)|(^\d\.[0]{1}[1-9]{1}$|(^\d\.[1-9]{1}[0]{1}$)$)/,
            message: "请正确输入税额",
            trigger: "blur"
          }
        ],
        contractAmountTax: [
          {
            required: true,
            message: "请输入不含税金额",
            trigger: "blur"
          },
          {
            pattern: /(^[1-9](\d+)?(\.\d{1,2})?$)|(^[1-9]$)|(^\d\.[1-9]{1,2}$)|(^\d\.[0]{1}[1-9]{1}$|(^\d\.[1-9]{1}[0]{1}$)$)/,
            message: "请正确输入不含税金额",
            trigger: "blur"
          }
        ],
        // proName: [
        //   {
        //     required: true,
        //     message: '请输入项目名称',
        //     trigger: 'blur'
        //   }
        // ],
        // proType: [
        //   {
        //     required: true,
        //     message: '请选择项目类型',
        //     trigger: 'blur'
        //   }
        // ]
      }
    };
  },
  created() {
    this.getList(); //获取页面数据
    this.getTreeselect();
    this.getDicts("collect_type").then(response => {
      this.collectTypeOptions = response.data;
    });
    findProjectType().then(response => {
      this.proTypeNameList = response.data;
    });
    findBranchOffice().then(response => {
          this.belongCompanyNameList = response.data;
    });
  },
  methods: {
    getDept (prov) {
      this.deptOptions = [];
      findDeptByBranchOffice(prov).then(
        response => {
          this.deptOptions = response.data;
        }
      );
    },
    //显示已选分公司名
    refreshComp(){
      console.log(this.form.selectComp);
    },
    openInfoWin(){
      this.editInfoVisible=true;
    },
    /** 审批按钮操作 */
    examineAndApprove(row) {
       this.deptOptions = [];
        const id = row.id || this.ids;
        const _selectData = this.$refs.itsmDataTable.selection
        let deleSta = 0;
        this.reset();
        this.open = true;
        this.audit = true;
        getCollectProject(id).then(response => {
          this.tableData_ = response.data.actWorkflowFormDatas;
          this.form = response.data;
          this.form.belongCompanyid = parseInt(this.form.belongCompanyid);
          this.title = "集客项目";
          /** 基本信息赋值 **/
          this.$refs.basicInfo.formData = this.form.appNgBase;
          this.$refs.basicInfo.formData.projectTypeId =
            this.form.appNgBase.projectTypeId + "";
          /** 材料信息 **/
          this.$refs.materialsInfo.dataList = this.form.appNgMaterialList;
          /** 施工费信息 **/
          this.$refs.construcostInfo.dataList = this.form.appNgConstList;
          if (this.form.appxNgReq.dataList) {
            this.$refs.approvalInfo.rowspanNum =
              13 + this.form.appxNgReq.dataList.length;
          }
          /** 事前审批 **/
          this.$refs.approvalInfo.formData = this.form.appxNgReq;
        });
         this.butVis = false;
    },
    /** 查看流程图 */
     examineAndApproves(row) {
       this.reset();
        let url = window.location.hostname;
       if(url.indexOf("http")<0){
         url = "http://"+url;
       }
        let hosturl = url+":9001/task/exportImage?processInstanceId="+row.instanceId;
        window.open(hosturl,"_blank");
     },
    remove() {
      this.queryParams.belongDeptid = "";
      this.queryParams.belongDeptName = "";
    },
    /** 点击选择部门操作 */
    clickChoiceDept() {
      if (!this.queryParams.belongCompanyid) {
        this.$message.error("请选择分公司");
      } else {
        this.depDialog = true;
        findDeptByBranchOffice(this.queryParams.belongCompanyid).then(
          response => {
            this.$refs.selectDep.treeData = response.data;
          }
        );
      }
    },
    /** 选择部门操作 */
    choiceDept() {
      this.depDialog = false;
      this.queryParams.belongDeptid = this.$refs.selectDep.checkedId;
      this.queryParams.belongDeptName = this.$refs.selectDep.checkedlabel;
      console.log(this.queryParams.belongDeptid);
    },
    //部门选择窗口关闭前事件
    handleClose(done) {},
    /** 查询事前审批主(集客类)列表 */
    getList() {
      this.loading = true;
      listCollectProject(this.queryParams).then(response => {
        this.collectProjectList = response.rows;
        this.total = response.total;
        this.loading = false;
      });
    },
    /** 查询部门下拉树结构 */
    getTreeselect() {
      treeselect().then(response => {
        //this.deptOptions = response.data;
      });
    },
    // 筛选节点
    filterNode(value, data) {
      if (!value) return true;
      return data.label.indexOf(value) !== -1;
    },
    // 节点单击事件
    handleNodeClick(data) {
      this.queryParams.deptId = data.id;
      this.getList();
    },
    // 取消按钮
    cancel() {
      this.open = false;
      this.activeName = "base";
      this.reset();
    },
    // 表单重置
    reset() {
       this.audit = false;
        this.butVis = true;
         this.deptOptions = [];
      this.form = {

        id: null,
        createBy: null,
        createTime: null,
        updateBy: null,
        updateTime: null,
        reqNo: null,
        proName: null,
        proType: null,
        proTypeName: null,
        belongCompanyid: null,
        belongCompanyName: null,
        belongDeptid: null,
        belongDeptName: null,
        contractAmountTotal: null,
        contractAmountTax: null,
        taxrate: null,
        taxamount: null,
        status: 0,
        statusPs: null,
        remarks: null,
        delFlag: null,
        appNgBase: null,
        appNgMaterialList: [],
        appNgConstList: [],
        appxNgReq: null

      };
      this.resetForm("form");
    },
    /** 搜索按钮操作 */
    handleQuery() {
      this.queryParams.pageNum = 1;
      this.getList();
    },
    /** 重置按钮操作 */
    resetQuery() {
      this.queryParams.belongDeptName = '';
      this.queryParams.belongDeptid = '';
      this.resetForm("queryForm");
      this.handleQuery();
    },
    handleClick(tab, event) {},
    // 多选框选中数据
    handleSelectionChange(selection) {
      this.ids = selection.map(item => item.id);
      this.single = selection.length !== 1;
      this.multiple = !selection.length;
    },
    // 单选框选中数据
    handleSelectionChange_(val) {
      if(val.length > 1){
              this.$refs.multipleTable.clearSelection()
              this.$refs.multipleTable.toggleRowSelection(val.pop())
            }else{
              this.chek = val;
            }
    },
    /** 新增按钮操作 */
    handleAdd() {
      this.reset();
      this.open = true;
      this.title = "集客项目";
      this.butVis = true;
      findLoginbyCompany().then(response => {
        this.$refs.approvalInfo.formData.applyCompany = response.msg;
      });
      findNextAppNo().then(response => {
        this.$refs.approvalInfo.formData.appxNgNo = response.msg;
      });

      getUserInfo().then(response1 => {

        if(response1.data.user.userName=='admin'){
          this.choise = false;
          //this.form.belongCompanyid=(response1.data.user.dept.deptId);
        }else{
           this.choise = true;
           this.form.belongCompanyid=(response1.data.user.dept.deptId);
            this.getDept (this.form.belongCompanyid)
        }

      });
    },
    /** 修改按钮操作 */
    handleUpdate(row) {
       const id = row.id || this.ids;
      const _selectData = this.$refs.itsmDataTable.selection
      let deleSta = 0;
      if(_selectData!=''){
        const flag = false;
        for(let item of _selectData) {
            if(item.status == 1 || item.status == 2){
              deleSta = 1;
              break;
            }
        }
        if(deleSta==1){
           this.msgSuccess("请修改未提交的数据");
           return false;
        }
      }
      this.reset();
      this.open = true;
      getCollectProject(id).then(response => {
        this.form = response.data;
        this.form.belongCompanyid = parseInt(this.form.belongCompanyid);
        this.title = "集客项目";
        /** 基本信息赋值 **/
        this.$refs.basicInfo.formData = this.form.appNgBase;
        this.$refs.basicInfo.formData.projectTypeId =
          this.form.appNgBase.projectTypeId + "";
        /** 材料信息 **/
        this.$refs.materialsInfo.dataList = this.form.appNgMaterialList;
        /** 施工费信息 **/
        this.$refs.construcostInfo.dataList = this.form.appNgConstList;
        if (this.form.appxNgReq.dataList) {
          this.$refs.approvalInfo.rowspanNum =
            13 + this.form.appxNgReq.dataList.length;
        }
        /** 事前审批 **/
        this.$refs.approvalInfo.formData = this.form.appxNgReq;

        if(response.data.status==0 || response.data.status==3 ){
          this.butVis = true;
        }else{
          this.butVis = false;
        }

        getUserInfo().then(response1 => {

          if(response1.data.user.userName=='admin'){
            this.choise = false;
             this.getDept (this.form.belongCompanyid)
          }else{
             this.choise = true;
             this.form.belongCompanyid=(response1.data.user.dept.deptId);
              this.getDept (this.form.belongCompanyid)
          }

        });
      });

    },
    cancelPar(){
      this.open_ = false;
    },
    submitOne(){
      this.title_ = "项目审批类型";
      this.open_ = true;
    },
     submitFormPar(number) {
       let _selectData = this.$refs.multipleTable.selection;
       if(_selectData==null || _selectData.length<=0){
           this.msgSuccess("请选择类别");
           return false;
       }
       this.submitForm(number);
     },

    /** 提交按钮 */
    submitForm(number) {

      this.form.appNgBase = this.$refs.basicInfo.formData;
      this.form.appNgMaterialList = this.$refs.materialsInfo.dataList;
      this.form.appNgConstList = this.$refs.construcostInfo.dataList;
      this.form.appxNgReq = this.$refs.approvalInfo.formData;
      // if(this.form.appNgBase.projectTypeId==null || this.form.appNgBase.projectTypeId==''){
      //    this.msgSuccess("项目类别不能为空");
      //    return false;
      // }
      // if(this.form.appNgBase.proName==null || this.form.appNgBase.proName==''){
      //    // this.msgSuccess("项目名称不能为空");
      //    // return false;
      // }if(this.form.appNgBase.proType==null || this.form.appNgBase.proType==''){
      //    this.msgSuccess("项目类型不能为空");
      //    return false;
      // }
      this.$refs["form"].validate(valid => {
        if (valid) {

          this.form.status = number;
          if(number==1){
          let _selectData = this.$refs.multipleTable.selection;
          this.form.instanceType = _selectData[0].num;
          }
          if (this.form.id != null) {
            updateCollectProject(this.form).then(response => {
              this.msgSuccess("修改成功");
              this.open = false;
              this.getList();
              this.open_ = false;
            });
          } else {
            addCollectProject(this.form).then(response => {
              this.msgSuccess("新增成功");
              this.open = false;
              this.getList();
              this.open_ = false;
            });
          }
        }
      });
    },
    /** 删除按钮操作 */
    handleDelete(row) {
      const ids = row.id || this.ids;
      const _selectData = this.$refs.itsmDataTable.selection
      let deleSta = 0;
      if(_selectData!=''){
        const flag = false;
        for(let item of _selectData) {
            if(item.status == 1 || item.status == 2){
              deleSta = 1;
              break;
            }
        }
        if(deleSta==1){
           this.msgSuccess("请删除未提交的数据");
           return false;
        }
      }
      this.$confirm(
        '是否确认删除该数据?',
        "警告",
        {
          confirmButtonText: "确定",
          cancelButtonText: "取消",
          type: "warning"
        }
      )
        .then(function() {
          return delCollectProject(ids);
        })
        .then(() => {
          this.getList();
          this.msgSuccess("删除成功");
        });
    },
    /** 导出按钮操作 */
    handleExport() {
      const queryParams = this.queryParams;
      this.$confirm("是否确认导出所有事前审批主(集客类)数据项?", "警告", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      })
        .then(function() {
          return exportCollectProject(queryParams);
        })
        .then(response => {
          this.download(response.msg);
        });
    },
    changeNum() {
      let contractAmountTotal = this.form.contractAmountTotal;
      let taxrate = this.form.taxrate;
      if (contractAmountTotal && taxrate) {
        /** 税率转换 **/
        let taxrateStr = taxrate / 100;
        this.form.contractAmountTax = this.formatPrice(
          contractAmountTotal / (1 + taxrateStr)
        );
        this.form.taxamount = this.formatPrice(
          contractAmountTotal - this.form.contractAmountTax
        );
      }
    },
    /** 格式化金额 **/
    formatPrice(value) {
      let tempVal = parseFloat(value).toFixed(3);
      let realVal = tempVal.substring(0, tempVal.length - 1);
      return realVal;
    },
    closeUserAdd() {
      this.activeName = "base";
      // materialsInfoDate
      this.$refs.basicInfo.formData = {
        branIdStr: [],
        companyCharge: "",
        departCharge: "",
        proCharge: "",
        projectTypeId: "",
        buildingsNumber: 0,
        buildingsInvolvedNumber: 0,
        digitaltvNumber: 0,
        broadbandNumber: 0,
        budgetMaterial: 0,
        budgetLabor: 0,
        budgetTotal: 0,
        designTime: ""
      };
      this.$refs.materialsInfo.dataList = [];
      this.$refs.construcostInfo.dataList = [];
      // this.$refs.construcostInfo.formData = {
      //   projectName: "",
      //   description: "",
      //   projectUnit: "",
      //   days: 0,
      //   daysPrice: 0,
      //   daysAmount: 0
      // };
      this.$refs.approvalInfo.formData = {
        id: null,
        appxNgNo: null,
        appxNgName: null,
        proType: null,
        applyDate: null,
        bid: null,
        applyCompany: null,
        tranrevenue: null,
        trantaxrate: 6,
        tranrevenueno: null,
        tranoutput: null,
        tranremarks: null,
        devicerevenue: null,
        devicetaxrate: 13,
        devicerevenueno: null,
        deviceoutput: null,
        deviceremarks: null,
        serverevenue: null,
        servetaxrate: 6,
        serverevenueno: null,
        serveoutput: null,
        serveremarks: null,
        projectrevenue: null,
        projecttaxrate: 9,
        projectrevenueno: null,
        projectoutput: null,
        projectremarks: null,
        leaserevenue: null,
        leasetaxrate: 6,
        leaserevenueno: null,
        leaseoutput: null,
        leaseremarks: null,
        softwarerevenue: null,
        softwaretaxrate: 13,
        softwarerevenueno: null,
        softwareoutput: null,
        softwareremarks: null,
        advertrevenue: null,
        adverttaxrate: 6,
        advertrevenueno: null,
        advertoutput: null,
        advertremarks: null,
        incomerevenue: null,
        incomerevenueno: null,
        incomeoutput: null,
        devicecostmoney: null,
        devicecosttaxrate: 13,
        devicecostmoneyno: null,
        devicecostincome: null,
        devicecostremarks: "无产权工程",
        stuffcostmoney: null,
        stuffcosttaxrate: 13,
        stuffcostmoneyno: null,
        stuffcostincome: null,
        stuffcostremarks: "无产权工程",
        turncostmoney: null,
        turncosttaxrate: 9,
        turncostmoneyno: null,
        turncostincome: null,
        turncostremarks: "无产权工程",
        servecostmoney: null,
        servecosttaxrate: 6,
        servecostmoneyno: null,
        servecostincome: null,
        servecostremarks: "无产权工程",
        buildcostmoney: null,
        buildcosttaxrate: 3,
        buildcostmoneyno: null,
        buildcostincome: null,
        buildcostremarks:
          "无产权工程，小规模纳税人税率3%，一般纳税人税率9%，根据施工方情况可修改税率",
        havedevicemoney: null,
        havedevicetaxrate: 13,
        havedevicemoneyno: null,
        havedeviceincome: null,
        havedeviceremarks:
          "自有产权工程，成本（不含税金额）按折旧计算，按投资形成资产月折旧金额*项目期限，即成本=折旧=设备不含税金额*0.95/折旧年限*服务年份，设备折旧年限8年，线路资产折旧年限15年",
        havelinemoney: null,
        havelinetaxrate: 9,
        havelinemoneyno: null,
        havelineincome: null,
        upholdcostmoney: null,
        upholdcosttaxrate: 6,
        upholdcostmoneyno: null,
        upholdcostincome: null,
        upholdcostremarks: null,
        othercostmoney: null,
        othercosttaxrate: null,
        othercostmoneyno: null,
        othercostincome: null,
        othercostremarks: null,
        interestcostmoney: null,
        interestcosttaxrate: null,
        interestcostmoneyno: null,
        interestcostincome: null,
        interestcostremarks:
          "政府采购项目经批准后可以垫资，需计算垫资利息作为项目成本，利率按4.35%计算。其他集客项目原则上不允许垫资。垫资金额   万元，垫资   月，垫资利息=垫资金额*4.35%/12*月份",
        costmoney: null,
        costmoneyno: null,
        costincome: null,
        incrementtaxrate: null,
        incrementremarks: null,
        attachtaxrate: null,
        attachremarks:
          "综合税率12.5%（城市维护建设税7%，教育费附加3%，地方教育费附加2%，地方水利建设基金0.5%）",
        culturebuild: null,
        culturebuildremarks:
          "费率3%，暂减按1.5%征收，文化事业建设费=广告收入*1.5%",
        estimateprofit: null,
        estimateprofitremarks: null,
        epmargin: null,
        epmarginremarks: null,
        remarks: null,
        dataList: []
      };
      this.reset();
    }
  }
};
</script>
<style scoped lang="scss">
.el-textarea .el-textarea__inner {
  resize: none;
}
::v-deep .el-dialog {
  .el-dialog__body {
    padding: 5px 20px;
  }
}
.curr-table {
  text-align: center;
  width: 100%;
  vertical-align: middle;
  border-spacing: 0px;
  border-style: none;
  border-collapse: collapse;
}
.curr-table td,th {
  padding: 5px 10px;
}
.curr-table th {
  font-weight: bold;
  background-color: #eff3fa;
  height: 40px;
}
</style>
